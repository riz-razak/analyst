<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard ‚Äî analyst.rizrazak.com</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Grotesk:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#070b10;--card:#0d1117;--card2:#111827;--border:#1f2937;--border2:#374151;
  --red:#dc2626;--redk:#991b1b;--gold:#d97706;--green:#059669;--blue:#1d4ed8;
  --purple:#7c3aed;--orange:#ea580c;
  --text:#f9fafb;--muted:#6b7280;--muted2:#9ca3af;
}
body{background:var(--bg);font-family:'JetBrains Mono',monospace;color:var(--text);min-height:100vh;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  background:var(--card);border-bottom:2px solid var(--red);
  padding:14px 32px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
}
.topbar-left{display:flex;align-items:center;gap:16px;}
.topbar-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:3px;}
.topbar-badge{font-size:0.55rem;letter-spacing:1.5px;text-transform:uppercase;background:var(--red);color:#fff;padding:3px 10px;border-radius:2px;}
.back-btn{color:var(--muted);font-size:0.6rem;text-decoration:none;letter-spacing:1px;text-transform:uppercase;border:1px solid var(--border);padding:5px 12px;border-radius:3px;transition:all .2s;}
.back-btn:hover{color:var(--text);border-color:var(--border2);}
.topbar-right{font-size:0.55rem;color:var(--muted);letter-spacing:1px;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{max-width:1400px;margin:0 auto;padding:32px 32px 80px;}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tab-bar{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:32px;overflow-x:auto;}
.tab{
  font-size:0.6rem;letter-spacing:1.5px;text-transform:uppercase;
  padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;
  margin-bottom:-2px;color:var(--muted);transition:all .2s;white-space:nowrap;
}
.tab:hover{color:var(--muted2);}
.tab.active{color:var(--text);border-bottom-color:var(--red);}
.tab-badge{
  display:inline-block;background:var(--red);color:#fff;
  font-size:0.5rem;padding:1px 5px;border-radius:8px;margin-left:6px;vertical-align:middle;
}
.tab-badge.gold{background:var(--gold);}
.tab-badge.green{background:var(--green);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px;margin-bottom:28px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-top:3px solid var(--red);border-radius:4px;padding:18px 20px;}
.stat-card.green{border-top-color:var(--green);}
.stat-card.gold{border-top-color:var(--gold);}
.stat-card.blue{border-top-color:var(--blue);}
.stat-card.purple{border-top-color:var(--purple);}
.sc-label{font-size:0.5rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px;}
.sc-val{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:1px;line-height:1;}
.sc-sub{font-size:0.5rem;color:var(--muted);margin-top:4px;}

/* ‚îÄ‚îÄ SECTION TITLES ‚îÄ‚îÄ */
.sect-title{
  font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:2px;
  margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:12px;
}
.sect-badge{font-size:0.5rem;background:var(--border2);padding:3px 8px;border-radius:2px;color:var(--muted2);letter-spacing:1px;font-family:'JetBrains Mono',monospace;}

/* ‚îÄ‚îÄ COMMENT CARDS ‚îÄ‚îÄ */
.comment-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
.cc{
  background:var(--card);border:1px solid var(--border);border-radius:4px;
  padding:16px 18px;
}
.cc.pending{border-left:3px solid var(--gold);}
.cc.approved{border-left:3px solid var(--green);}
.cc.flagged{border-left:3px solid var(--red);}
.cc.rejected{border-left:3px solid var(--muted);opacity:0.5;}
.cc-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:12px;}
.cc-meta{display:flex;flex-wrap:wrap;gap:8px;align-items:center;}
.cc-id{font-size:0.55rem;background:var(--border);padding:2px 7px;border-radius:2px;color:var(--muted2);}
.cc-status{font-size:0.5rem;text-transform:uppercase;letter-spacing:1px;padding:2px 8px;border-radius:2px;}
.cc-status.pending{background:rgba(217,119,6,0.2);color:#fbbf24;}
.cc-status.approved{background:rgba(5,150,105,0.2);color:#34d399;}
.cc-status.flagged{background:rgba(220,38,38,0.2);color:#f87171;}
.cc-status.rejected{background:rgba(107,114,128,0.2);color:#9ca3af;}
.cc-time{font-size:0.5rem;color:var(--muted);}
.cc-actions{display:flex;gap:6px;flex-shrink:0;}
.cc-btn{
  font-size:0.55rem;letter-spacing:1px;text-transform:uppercase;
  border:none;padding:5px 10px;border-radius:2px;cursor:pointer;transition:all .2s;
  font-family:'JetBrains Mono',monospace;
}
.cc-btn.approve{background:var(--green);color:#fff;}
.cc-btn.approve:hover{background:#047857;}
.cc-btn.flag{background:rgba(220,38,38,0.2);color:#f87171;border:1px solid rgba(220,38,38,0.3);}
.cc-btn.flag:hover{background:rgba(220,38,38,0.35);}
.cc-btn.reject{background:rgba(107,114,128,0.15);color:var(--muted2);border:1px solid var(--border);}
.cc-btn.reject:hover{background:rgba(107,114,128,0.25);}
.cc-btn.unapprove{background:rgba(217,119,6,0.2);color:#fbbf24;border:1px solid rgba(217,119,6,0.3);}
.cc-text{font-family:'Space Grotesk',sans-serif;font-size:0.82rem;line-height:1.6;color:var(--muted2);margin-bottom:10px;}
.cc-detail{font-size:0.52rem;color:var(--muted);display:flex;flex-wrap:wrap;gap:12px;}
.cc-detail span{display:flex;align-items:center;gap:4px;}
.cc-ip{font-size:0.55rem;background:rgba(30,64,175,0.15);color:#93c5fd;border:1px solid rgba(30,64,175,0.25);padding:2px 7px;border-radius:2px;}
.cc-geo{font-size:0.55rem;color:#fbbf24;}
.cc-tos{font-size:0.5rem;background:rgba(5,150,105,0.1);color:#34d399;border:1px solid rgba(5,150,105,0.2);padding:2px 7px;border-radius:2px;}

/* ‚îÄ‚îÄ ALLEGED CHECKER ‚îÄ‚îÄ */
.checker-box{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:24px;}
.checker-input-row{display:flex;gap:10px;margin-bottom:16px;}
.checker-url{
  flex:1;background:var(--card2);border:1px solid var(--border2);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:0.75rem;
  padding:10px 14px;border-radius:3px;outline:none;
}
.checker-url:focus{border-color:var(--gold);}
.checker-btn{
  background:var(--gold);color:#fff;border:none;
  font-family:'JetBrains Mono',monospace;font-size:0.65rem;letter-spacing:1px;
  text-transform:uppercase;padding:10px 18px;border-radius:3px;cursor:pointer;
  transition:all .2s;white-space:nowrap;
}
.checker-btn:hover{background:#b45309;}
.checker-results{margin-top:16px;}
.checker-claim{
  background:var(--card2);border-radius:3px;padding:12px 16px;margin-bottom:8px;
  border-left:3px solid var(--red);font-size:0.75rem;
}
.checker-claim.ok{border-left-color:var(--green);}
.checker-claim.warn{border-left-color:var(--gold);}
.claim-label{font-size:0.5rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.claim-label.ok{color:var(--green);}
.claim-label.warn{color:#fbbf24;}
.claim-label.err{color:#f87171;}
.claim-text{color:var(--muted2);line-height:1.5;}
.checker-summary{
  background:rgba(5,150,105,0.1);border:1px solid rgba(5,150,105,0.25);
  border-radius:3px;padding:12px 16px;margin-bottom:16px;font-size:0.7rem;color:var(--muted2);
}
.checker-summary.issues{background:rgba(220,38,38,0.08);border-color:rgba(220,38,38,0.25);}

/* ‚îÄ‚îÄ SETUP GUIDE ‚îÄ‚îÄ */
.setup-step{
  background:var(--card);border:1px solid var(--border);border-radius:4px;
  padding:18px 20px;margin-bottom:10px;display:flex;gap:16px;align-items:flex-start;
}
.step-num{
  font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--muted);
  line-height:1;flex-shrink:0;width:32px;text-align:center;
}
.step-title{font-size:0.7rem;color:var(--text);margin-bottom:4px;text-transform:uppercase;letter-spacing:1px;}
.step-body{font-size:0.65rem;color:var(--muted2);line-height:1.6;}
.step-body code{background:var(--border);padding:1px 5px;border-radius:2px;font-size:0.6rem;color:#fbbf24;}
.step-body a{color:#60a5fa;text-decoration:none;}
.step-body a:hover{text-decoration:underline;}
.step-status{
  font-size:0.5rem;text-transform:uppercase;letter-spacing:1px;
  padding:2px 7px;border-radius:2px;margin-top:6px;display:inline-block;
}
.step-status.done{background:rgba(5,150,105,0.2);color:#34d399;}
.step-status.todo{background:rgba(217,119,6,0.2);color:#fbbf24;}
.step-status.required{background:rgba(220,38,38,0.2);color:#f87171;}

/* ‚îÄ‚îÄ LEGAL BRIEF ‚îÄ‚îÄ */
.legal-item{
  background:var(--card);border:1px solid var(--border);border-left:3px solid var(--blue);
  border-radius:4px;padding:16px 20px;margin-bottom:10px;
}
.legal-item.green{border-left-color:var(--green);}
.legal-item.gold{border-left-color:var(--gold);}
.legal-item.red{border-left-color:var(--red);}
.legal-title{font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--text);margin-bottom:6px;}
.legal-body{font-size:0.68rem;color:var(--muted2);line-height:1.65;}
.legal-body strong{color:var(--muted2);}
.risk-pill{
  display:inline-block;font-size:0.5rem;text-transform:uppercase;letter-spacing:1px;
  padding:2px 8px;border-radius:2px;margin-left:8px;
}
.risk-low{background:rgba(5,150,105,0.2);color:#34d399;}
.risk-med{background:rgba(217,119,6,0.2);color:#fbbf24;}
.risk-high{background:rgba(220,38,38,0.2);color:#f87171;}

/* ‚îÄ‚îÄ GDPR PANEL ‚îÄ‚îÄ */
.gdpr-panel{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:24px;margin-bottom:16px;}
.gdpr-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
.gdpr-row:last-child{border-bottom:none;}
.gdpr-label{font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted2);}
.gdpr-val{font-size:0.65rem;color:var(--text);}
.gdpr-val.ok{color:#34d399;}
.gdpr-val.warn{color:#fbbf24;}
.gdpr-val.err{color:#f87171;}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state{
  text-align:center;padding:40px;color:var(--muted);
  font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;
}
.empty-state .icon{font-size:2rem;margin-bottom:12px;display:block;}

/* ‚îÄ‚îÄ ANALYTICS TAB ‚îÄ‚îÄ */
.anl-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;}
@media(max-width:768px){.anl-grid{grid-template-columns:1fr;}}
.anl-card{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:20px;}
.anl-card-title{font-size:0.55rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.anl-card-title span{font-size:1rem;}
.anl-id-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);}
.anl-id-row:last-child{border-bottom:none;}
.anl-id-label{font-size:0.55rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);}
.anl-id-val{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text);}
.anl-id-val.placeholder{color:#f87171;}
.anl-id-val.live{color:#34d399;}
.anl-input{
  width:100%;background:var(--card2);border:1px solid var(--border2);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:0.7rem;
  padding:8px 12px;border-radius:3px;outline:none;margin-top:6px;
}
.anl-input:focus{border-color:var(--gold);}
.anl-save-btn{
  background:var(--green);color:#fff;border:none;
  font-family:'JetBrains Mono',monospace;font-size:0.55rem;letter-spacing:1px;
  text-transform:uppercase;padding:7px 14px;border-radius:3px;cursor:pointer;margin-top:8px;transition:all .2s;
}
.anl-save-btn:hover{background:#047857;}
.coverage-table{width:100%;border-collapse:collapse;}
.coverage-table th{font-size:0.5rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);}
.coverage-table td{font-size:0.62rem;padding:8px 10px;border-bottom:1px solid var(--border);color:var(--muted2);}
.coverage-table tr:last-child td{border-bottom:none;}
.cov-ok{color:#34d399;}
.cov-err{color:#f87171;}
.dash-links{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:0;}
@media(max-width:768px){.dash-links{grid-template-columns:1fr;}}
.dash-link{
  display:flex;align-items:center;gap:12px;
  background:var(--card2);border:1px solid var(--border);border-radius:4px;
  padding:14px 16px;text-decoration:none;color:var(--text);transition:all .2s;
}
.dash-link:hover{border-color:var(--border2);background:var(--border);}
.dash-link-icon{font-size:1.4rem;}
.dash-link-info{}
.dash-link-title{font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;}
.dash-link-desc{font-size:0.52rem;color:var(--muted);}
.anl-coverage-wrap{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:20px;}
.seo-item{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--border2);border-radius:4px;padding:14px 18px;margin-bottom:10px;}
.seo-item.done{border-left-color:var(--green);}
.seo-item.wip{border-left-color:var(--gold);}
.seo-item.todo{border-left-color:var(--blue);}
.seo-title{font-size:0.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text);margin-bottom:4px;}
.seo-body{font-size:0.62rem;color:var(--muted2);line-height:1.6;}

/* ‚îÄ‚îÄ PASTE AREA ‚îÄ‚îÄ */
.paste-area{
  width:100%;background:var(--card2);border:1px solid var(--border2);color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:0.65rem;
  padding:12px 14px;border-radius:3px;outline:none;resize:vertical;min-height:120px;
}
.paste-area:focus{border-color:var(--gold);}

/* ‚îÄ‚îÄ WEEKLY BRIEFING ‚îÄ‚îÄ */
.briefing-panel{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--gold);border-radius:4px;padding:20px 24px;margin-bottom:24px;}
.briefing-q{font-family:'Space Grotesk',sans-serif;font-size:0.72rem;color:var(--text);margin-bottom:4px;font-weight:500;}
.briefing-a{font-size:0.62rem;color:var(--muted2);line-height:1.6;margin-bottom:14px;padding-left:12px;border-left:2px solid var(--border);}
.briefing-a:last-child{margin-bottom:0;}
.briefing-a .val{color:var(--text);font-weight:600;}
.briefing-a .up{color:#34d399;}
.briefing-a .down{color:#f87171;}
.briefing-a .flat{color:#fbbf24;}
.briefing-header{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:2px;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.briefing-date{font-size:0.55rem;color:var(--muted);letter-spacing:1px;font-family:'JetBrains Mono',monospace;}

/* ‚îÄ‚îÄ CREDIBILITY CARDS ‚îÄ‚îÄ */
.cred-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-bottom:20px;}
.cred-card{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:16px 18px;position:relative;overflow:hidden;}
.cred-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
.cred-card.trust::before{background:var(--green);}
.cred-card.growth::before{background:var(--gold);}
.cred-card.risk::before{background:var(--red);}
.cred-label{font-size:0.48rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:6px;}
.cred-val{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:1px;line-height:1;}
.cred-sub{font-size:0.48rem;color:var(--muted);margin-top:3px;}
.cred-trend{font-size:0.5rem;margin-top:6px;padding:2px 7px;border-radius:2px;display:inline-block;}
.cred-trend.up{background:rgba(5,150,105,0.15);color:#34d399;}
.cred-trend.down{background:rgba(220,38,38,0.15);color:#f87171;}
.cred-trend.flat{background:rgba(217,119,6,0.15);color:#fbbf24;}

/* ‚îÄ‚îÄ RISK SIGNAL ‚îÄ‚îÄ */
.risk-signal{background:var(--card);border:1px solid var(--border);border-left:3px solid var(--green);border-radius:4px;padding:14px 18px;margin-bottom:8px;display:flex;align-items:flex-start;gap:14px;}
.risk-signal.warn{border-left-color:var(--gold);}
.risk-signal.alert{border-left-color:var(--red);}
.risk-icon{font-size:1.2rem;flex-shrink:0;margin-top:2px;}
.risk-info{flex:1;}
.risk-name{font-size:0.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--text);margin-bottom:3px;}
.risk-desc{font-size:0.58rem;color:var(--muted2);line-height:1.5;}
.risk-val{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--text);flex-shrink:0;}

/* ‚îÄ‚îÄ PHASE INDICATOR ‚îÄ‚îÄ */
.phase-bar{display:flex;gap:0;margin-bottom:24px;border-radius:4px;overflow:hidden;height:32px;}
.phase-seg{display:flex;align-items:center;justify-content:center;font-size:0.5rem;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,0.9);transition:flex .5s;}
.phase-seg.p1{background:var(--red);}
.phase-seg.p2{background:var(--gold);}
.phase-seg.p3{background:var(--green);}

/* ‚îÄ‚îÄ INFO BOX ‚îÄ‚îÄ */
.info-box{
  background:rgba(30,64,175,0.08);border:1px solid rgba(30,64,175,0.25);
  border-radius:3px;padding:12px 16px;margin-bottom:16px;font-size:0.65rem;color:var(--muted2);line-height:1.6;
}
.info-box.gold{background:rgba(217,119,6,0.08);border-color:rgba(217,119,6,0.25);}
.info-box.green{background:rgba(5,150,105,0.08);border-color:rgba(5,150,105,0.25);}
.info-box strong{color:var(--muted2);}

.refresh-btn{
  background:transparent;border:1px solid var(--border2);color:var(--muted2);
  font-family:'JetBrains Mono',monospace;font-size:0.55rem;letter-spacing:1px;
  text-transform:uppercase;padding:6px 12px;border-radius:3px;cursor:pointer;transition:all .2s;
}
.refresh-btn:hover{background:var(--border);color:var(--text);}

.filter-row{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center;}
.filter-label{font-size:0.55rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.filter-btn{
  font-size:0.55rem;letter-spacing:1px;text-transform:uppercase;
  border:1px solid var(--border);color:var(--muted2);padding:4px 10px;border-radius:2px;
  cursor:pointer;background:transparent;transition:all .2s;font-family:'JetBrains Mono',monospace;
}
.filter-btn.active{background:var(--border2);color:var(--text);}
.approve-all-btn{
  background:rgba(5,150,105,0.2);color:#34d399;border:1px solid rgba(5,150,105,0.3);
  font-family:'JetBrains Mono',monospace;font-size:0.55rem;letter-spacing:1px;
  text-transform:uppercase;padding:6px 14px;border-radius:3px;cursor:pointer;transition:all .2s;
}
.approve-all-btn:hover{background:rgba(5,150,105,0.3);}
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <a class="back-btn" href="kalathma-scandal.html">‚Üê Case File</a>
    <span class="topbar-title">Admin Dashboard</span>
    <span class="topbar-badge">Private ¬∑ Riz Only</span>
  </div>
  <div class="topbar-right" id="clock">‚Äî</div>
</div>

<div class="main">

  <!-- STAT OVERVIEW -->
  <div class="stat-grid" id="stat-grid">
    <div class="stat-card"><div class="sc-label">Total Comments</div><div class="sc-val" id="sc-total">0</div><div class="sc-sub">all time</div></div>
    <div class="stat-card gold"><div class="sc-label">Pending Review</div><div class="sc-val" id="sc-pending">0</div><div class="sc-sub">awaiting approval</div></div>
    <div class="stat-card green"><div class="sc-label">Approved</div><div class="sc-val" id="sc-approved">0</div><div class="sc-sub">publicly visible</div></div>
    <div class="stat-card"><div class="sc-label">Flagged</div><div class="sc-val" id="sc-flagged">0</div><div class="sc-sub">high legal risk</div></div>
    <div class="stat-card blue"><div class="sc-label">ToS Accepted</div><div class="sc-val" id="sc-tos">‚Äî</div><div class="sc-sub">this browser</div></div>
    <div class="stat-card purple"><div class="sc-label">GDPR Consent</div><div class="sc-val" id="sc-gdpr">‚Äî</div><div class="sc-sub">this browser</div></div>
  </div>

  <!-- TABS -->
  <div class="tab-bar">
    <div class="tab active" data-tab="comments" onclick="switchTab('comments')">
      üí¨ Comments <span class="tab-badge gold" id="tab-pending-count">0</span>
    </div>
    <div class="tab" data-tab="checker" onclick="switchTab('checker')">
      üîç Alleged Checker
    </div>
    <div class="tab" data-tab="gdpr" onclick="switchTab('gdpr')">
      üîí GDPR &amp; Privacy
    </div>
    <div class="tab" data-tab="legal" onclick="switchTab('legal')">
      ‚öñÔ∏è Legal Brief
    </div>
    <div class="tab" data-tab="setup" onclick="switchTab('setup')">
      ‚öôÔ∏è Backend Setup
    </div>
    <div class="tab" data-tab="analytics" onclick="switchTab('analytics')">
      üìä Analytics
    </div>
    <div class="tab" data-tab="seo" onclick="switchTab('seo')">
      üîé SEO / AEO
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 1: COMMENTS APPROVAL QUEUE ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel active" id="tab-comments">
    <div class="info-box gold">
      <strong>Approval Workflow:</strong> All comments are saved as <code>pending</code> on the public page. Use Approve / Reject / Flag below. Only approved comments appear publicly.
      Approved IDs are stored in <code>slc_approved_ids_v1</code> localStorage key ‚Äî sync'd back to the case file automatically on next visit.
      <br><br>
      <strong>Note:</strong> This dashboard reads from the same browser's localStorage. For cross-device moderation, set up Supabase (see Backend Setup tab).
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="filter-row" style="margin-bottom:0;">
        <span class="filter-label">Show:</span>
        <button class="filter-btn active" onclick="setFilter('all',this)">All</button>
        <button class="filter-btn" onclick="setFilter('pending',this)">Pending</button>
        <button class="filter-btn" onclick="setFilter('approved',this)">Approved</button>
        <button class="filter-btn" onclick="setFilter('flagged',this)">Flagged</button>
        <button class="filter-btn" onclick="setFilter('rejected',this)">Rejected</button>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="approve-all-btn" onclick="approveAllPending()">‚úì Approve All Pending</button>
        <button class="refresh-btn" onclick="loadDashboard()">‚Üª Refresh</button>
      </div>
    </div>

    <div class="comment-list" id="comment-list">
      <div class="empty-state"><span class="icon">üí¨</span>No comments yet. They'll appear here as visitors submit them.</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 2: TWO-PASS ALLEGED CHECKER ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-checker">
    <div class="info-box">
      <strong>Two-Pass Alleged Checker:</strong> Paste the text of any section below to scan for factual claims about named individuals that lack a compliance label (ALLEGED, CONFIRMED, UNVERIFIED, REPORTED). Defamation risk is highest on bare assertions of fact presented as established truth.
    </div>

    <div class="checker-box">
      <div class="sect-title" style="font-size:1.1rem;border:none;margin-bottom:14px;">
        Paste Content for Compliance Scan
        <span class="sect-badge">Pass 1: Name Detection ¬∑ Pass 2: Label Check</span>
      </div>

      <textarea class="paste-area" id="checker-input" placeholder="Paste section text here ‚Äî e.g. copy a paragraph from the case file that names specific players or individuals...

Example: 'Danushka Gunathilaka was involved in a serious incident in January 2021 at a Galle hotel during a team gathering.'

The scanner will flag named-person claims missing ALLEGED/CONFIRMED/UNVERIFIED labels."></textarea>

      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center;">
        <button class="checker-btn" onclick="runChecker()">üîç Run Compliance Scan</button>
        <button class="checker-btn" style="background:var(--blue);" onclick="scanFullPage()">üìÑ Scan Full Case File</button>
        <button class="checker-btn" style="background:var(--border2);color:var(--muted2);" onclick="clearChecker()">‚úï Clear</button>
      </div>

      <div id="checker-output" style="margin-top:20px;"></div>
    </div>

    <!-- COMPLIANCE RULES -->
    <div style="margin-top:24px;">
      <div class="sect-title" style="font-size:1rem;">Compliance Label Reference</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;">
        <div class="setup-step">
          <div class="step-num" style="color:#34d399;">‚úì</div>
          <div>
            <div class="step-title" style="color:#34d399;">CONFIRMED</div>
            <div class="step-body">Court records, official SLC statements, journalist investigations with named sources. Use when you have documentary evidence or adjudicated fact.</div>
          </div>
        </div>
        <div class="setup-step">
          <div class="step-num" style="color:#fbbf24;">~</div>
          <div>
            <div class="step-title" style="color:#fbbf24;">ALLEGED / REPORTED</div>
            <div class="step-body">Social media claims, single-source reports, unverified testimony. Use liberally for anything not confirmed by primary sources.</div>
          </div>
        </div>
        <div class="setup-step">
          <div class="step-num" style="color:#f87171;">?</div>
          <div>
            <div class="step-title" style="color:#f87171;">UNVERIFIED</div>
            <div class="step-body">Rumour, tip, KalathmaGate-derived. Speculation presented in analysis context. Must be explicit about uncertainty. Never present as fact.</div>
          </div>
        </div>
        <div class="setup-step">
          <div class="step-num" style="color:#93c5fd;">¬ß</div>
          <div>
            <div class="step-title" style="color:#93c5fd;">Two-Source Rule</div>
            <div class="step-body">Before publishing any named allegation: minimum 2 independent sources, or one documentary source. Template: <code>[NAME] allegedly [ACTION], per [SOURCE] and [SOURCE].</code></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 3: GDPR & PRIVACY ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-gdpr">
    <div class="gdpr-panel">
      <div class="sect-title" style="font-size:1.1rem;border:none;margin-bottom:20px;">Data Processing Status ‚Äî This Browser</div>
      <div class="gdpr-row">
        <span class="gdpr-label">GDPR Consent Recorded</span>
        <span class="gdpr-val" id="gd-consent">‚Äî</span>
      </div>
      <div class="gdpr-row">
        <span class="gdpr-label">Consent Timestamp</span>
        <span class="gdpr-val" id="gd-consent-ts">‚Äî</span>
      </div>
      <div class="gdpr-row">
        <span class="gdpr-label">ToS Acceptance Recorded</span>
        <span class="gdpr-val" id="gd-tos">‚Äî</span>
      </div>
      <div class="gdpr-row">
        <span class="gdpr-label">ToS Acceptance Timestamp</span>
        <span class="gdpr-val" id="gd-tos-ts">‚Äî</span>
      </div>
      <div class="gdpr-row">
        <span class="gdpr-label">IP in Comments (raw)</span>
        <span class="gdpr-val" id="gd-ip-raw">‚Äî</span>
      </div>
      <div class="gdpr-row">
        <span class="gdpr-label">90-Day Purge Due</span>
        <span class="gdpr-val" id="gd-purge">‚Äî</span>
      </div>
      <div class="gdpr-row">
        <span class="gdpr-label">Total Comments in localStorage</span>
        <span class="gdpr-val" id="gd-total">‚Äî</span>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:24px;flex-wrap:wrap;">
      <button class="checker-btn" onclick="purgeRawIPs()">üîí Hash All Raw IPs Now</button>
      <button class="checker-btn" style="background:var(--red);" onclick="purgeOldComments()">üóë Purge Comments &gt;90 Days</button>
      <button class="checker-btn" style="background:var(--border2);color:var(--muted2);" onclick="exportComments()">üì• Export JSON Backup</button>
    </div>

    <div class="sect-title" style="font-size:1.1rem;">Privacy Policy Requirements ‚Äî Implementation Checklist</div>
    <div class="legal-item green">
      <div class="legal-title">‚úÖ IP Logging ‚Äî Lawful Basis</div>
      <div class="legal-body">IP addresses are collected under <strong>legitimate interest</strong> ‚Äî specifically, to defend against defamation claims and identify harassment. This is standard practice for publications accepting user comments. The basis is documented in the privacy policy (privacy.html). GDPR Art. 6(1)(f) applies. <strong>Action: Create privacy.html</strong> (see button below).</div>
    </div>
    <div class="legal-item gold">
      <div class="legal-title">‚ö†Ô∏è Data Minimisation ‚Äî 90-Day Rule</div>
      <div class="legal-body">Raw IP addresses should be replaced with an irreversible hash after 90 days. The hash is sufficient for linking future submissions from the same device, while reducing personal data exposure. Use the "Hash All Raw IPs" button above, or set up a cron job. <strong>Current policy: manual purge required.</strong></div>
    </div>
    <div class="legal-item green">
      <div class="legal-title">‚úÖ Consent Banner</div>
      <div class="legal-body">GDPR consent banner is implemented on kalathma-scandal.html. Consent is recorded in localStorage with timestamp and version. Users who decline analytics still receive service but IP is not captured for comments. Banner uses a "Understood / Decline Analytics" two-option design ‚Äî no pre-ticked boxes.</div>
    </div>
    <div class="legal-item green">
      <div class="legal-title">‚úÖ ToS Liability Transfer</div>
      <div class="legal-body">Terms of Service modal implemented. Users must accept before posting. Acceptance is logged with IP, timestamp, session ID, and ToS version. This creates a clear record that <strong>commenters accepted sole liability for their submissions</strong> ‚Äî strengthening the platform's editorial immunity defence.</div>
    </div>
    <div class="legal-item">
      <div class="legal-title">‚¨ú Privacy Policy Page (privacy.html)</div>
      <div class="legal-body">A machine-readable privacy policy is required for GDPR compliance and strengthens the liability framework. It should cover: data collected, legal basis, retention periods, user rights (access, erasure, correction), and contact details. Hosted at the same domain.</div>
    </div>

    <button class="checker-btn" style="margin-top:16px;" onclick="generatePrivacyPage()">üìÑ Generate privacy.html</button>
    <button class="checker-btn" style="margin-top:16px;margin-left:10px;background:var(--blue);" onclick="generateTermsPage()">üìÑ Generate terms.html</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 4: LEGAL BRIEF ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-legal">
    <div class="info-box green">
      <strong>Status as of Feb 2026:</strong> Platform is hosted on GitHub Pages (US servers). Domain registered via Cloudflare (US company). Analysis is framed as investigative commentary on matters of public interest. These structural choices provide significant legal protection.
    </div>

    <div class="legal-item green">
      <div class="legal-title">US Hosting ‚Äî First Amendment Protection <span class="risk-pill risk-low">Low Risk</span></div>
      <div class="legal-body">GitHub Pages (Microsoft Azure, US datacenters). All content is served from US infrastructure. Under <em>New York Times v. Sullivan</em> (1964) and its progeny, statements about public figures require proof of <strong>actual malice</strong> ‚Äî knowledge of falsity or reckless disregard for truth. Sri Lankan cricketers playing at international level are public figures by any standard. The bar for a successful US defamation claim against this platform is extremely high. <strong>US courts have jurisdiction over the domain; Sri Lankan courts do not.</strong></div>
    </div>

    <div class="legal-item green">
      <div class="legal-title">Cloudflare Proxy ‚Äî Sri Lankan IP Obscuration <span class="risk-pill risk-low">Low Risk</span></div>
      <div class="legal-body">When the domain is proxied through Cloudflare (US company), the actual server IP is hidden. Sri Lankan ISPs cannot directly block the origin server. Cloudflare also provides DDoS protection and can absorb legal pressure for a period. <strong>Action required:</strong> Ensure DNS is proxied (orange cloud in Cloudflare dashboard) rather than DNS-only.</div>
    </div>

    <div class="legal-item gold">
      <div class="legal-title">KalathmaGate ‚Äî Age Correction Applied <span class="risk-pill risk-low">Updated</span></div>
      <div class="legal-body">Kalathma Hitihamige was 17 years old at the time of the TikTok video in early 2023. She has since turned 18 (November 2025). The case file has been updated to read <strong>"then just 17 years old ‚Äî a teenager"</strong> and notes she has since reached majority. This framing preserves the moral argument (elite using legal threats against a teenager) while removing any suggestion she is currently a minor, which reduces legal surface area. The legal complaint stands on its own merits regardless of her current age.</div>
    </div>

    <div class="legal-item gold">
      <div class="legal-title">Comments Section ‚Äî Liability Transfer <span class="risk-pill risk-med">Medium Risk</span></div>
      <div class="legal-body">ToS modal is now in place. Every commenter must explicitly accept that they are <strong>solely responsible</strong> for their submission, that their IP is logged, and that the platform operator bears no liability for user content. This mirrors the framework used by newspapers and major platforms. Combined with pre-moderation (pending queue), the platform's exposure from user comments is significantly reduced. <strong>47 U.S.C. ¬ß 230</strong> (Communications Decency Act) further immunises the platform from liability for third-party content, provided it is not the "information content provider." Do not materially edit submitted comments ‚Äî pass through or reject only.</div>
    </div>

    <div class="legal-item">
      <div class="legal-title">Anonymous Domain Registration <span class="risk-pill risk-med">Recommended</span></div>
      <div class="legal-body">Current WHOIS data for rizrazak.com should be reviewed. If personal details are visible, consider domain privacy (most registrars offer this free, including Cloudflare Registrar). This prevents trivial identification via WHOIS lookup. Note: a determined adversary with legal standing can compel registrar disclosure, but this raises the bar considerably for informal pressure.</div>
    </div>

    <div class="legal-item red">
      <div class="legal-title">Sri Lanka Computer Crimes Act 2007 ‚Äî Watch List <span class="risk-pill risk-high">Monitor</span></div>
      <div class="legal-body">Section 3(1) of the CCCA criminalises "unauthorised access" broadly, and has been used against journalists. However, the Act targets <em>unauthorised computer access</em>, not publication of information. Section 32 (relating to data) has been attempted against social media users. Practical protection: US hosting means Sri Lankan authorities cannot compel content removal without US legal proceedings, which require meeting US legal standards. Maintain the editorial distinction between confirmed facts and clearly-labelled allegations.</div>
    </div>

    <div class="legal-item green">
      <div class="legal-title">Two-Source Rule ‚Äî Editorial Standard <span class="risk-pill risk-low">Implemented</span></div>
      <div class="legal-body">Mandatory before publishing named allegations: minimum two independent sources OR one documentary source (court record, official statement, journalist investigation). All unsourced allegations must be labelled ALLEGED/UNVERIFIED. Run the Alleged Checker tool (see tab above) before every publish. This is both an ethical and legal safeguard ‚Äî it demonstrates editorial diligence if the platform is ever challenged.</div>
    </div>

    <div class="legal-item">
      <div class="legal-title">Private Sources Log (sources.html) <span class="risk-pill risk-med">Pending</span></div>
      <div class="legal-body">Maintain a separate, password-protected log of your sources for each published claim. This is never published ‚Äî it exists purely to demonstrate to a court or legal adviser that your reporting is grounded in real sources. Journalist shield law protections (weak in Sri Lanka, stronger under US law if publication is based in US) may protect source identities. The sources log page is pending creation (see Backend Setup tab).</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 5: BACKEND SETUP ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-setup">
    <div class="info-box">
      <strong>Current State:</strong> Comments are stored in <code>localStorage</code> (browser-local). This works for single-browser testing but doesn't persist across visitors. The setup steps below move you to a production-ready stack with cross-device moderation.
    </div>

    <div class="setup-step">
      <div class="step-num">1</div>
      <div>
        <div class="step-title">Formspree ‚Äî Email Notification</div>
        <div class="step-body">
          Create free account at <a href="https://formspree.io" target="_blank">formspree.io</a> ‚Üí New form ‚Üí copy Form ID (e.g. <code>xrgjabc</code>).<br>
          Open <code>kalathma-scandal.html</code> ‚Üí find <code>const FORMSPREE_ID = 'YOUR_FORMSPREE_ID'</code> ‚Üí replace with your ID.<br>
          You'll receive an email for every submitted comment with the full text, IP, geo, and ID.
          <div><span class="step-status todo">Setup Required</span></div>
        </div>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">2</div>
      <div>
        <div class="step-title">Supabase ‚Äî Cross-Device Comment Storage + Approval</div>
        <div class="step-body">
          Create free account at <a href="https://supabase.com" target="_blank">supabase.com</a> ‚Üí New project ‚Üí SQL Editor ‚Üí run:
          <br><br>
          <code>CREATE TABLE comments (id TEXT PRIMARY KEY, text TEXT, ts BIGINT, ip TEXT, ip_hash TEXT, ua TEXT, geo TEXT, page TEXT, status TEXT DEFAULT 'pending', flagged BOOLEAN DEFAULT false, tos_accepted BOOLEAN, tos_ts BIGINT);</code>
          <br><br>
          Enable Row Level Security. Allow anonymous INSERT. Require authenticated SELECT/UPDATE (for admin approval). Once set up, replace <code>saveComment()</code>/<code>loadComments()</code> in kalathma-scandal.html with Supabase client calls.
          <div><span class="step-status todo">Setup Required</span></div>
        </div>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">3</div>
      <div>
        <div class="step-title">Plausible Analytics ‚Äî Privacy-Safe Traffic Tracking</div>
        <div class="step-body">
          <a href="https://plausible.io" target="_blank">plausible.io</a> ‚Äî GDPR-compliant, no cookies, no personal data. $9/month or self-hostable. Add one script tag to each HTML page. Provides real-time visitor counts, geographic data, referral sources. Replace hits.seeyoufarm.com badge.
          <div><span class="step-status todo">Optional</span></div>
        </div>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">4</div>
      <div>
        <div class="step-title">Cloudflare ‚Äî Proxy + DDoS + Geographic Blocking</div>
        <div class="step-body">
          If not already: move domain DNS to Cloudflare (free plan). Enable proxy (orange cloud) on the A/CNAME record for analyst.rizrazak.com. This hides origin IP and provides DDoS protection.
          Optional: in Cloudflare Firewall ‚Üí create rule to rate-limit requests from Sri Lanka if under legal pressure (aggressive but available as nuclear option).
          <div><span class="step-status todo">Recommended</span></div>
        </div>
      </div>
    </div>

    <div class="setup-step">
      <div class="step-num">5</div>
      <div>
        <div class="step-title">Sources Log ‚Äî Private Password-Protected Page</div>
        <div class="step-body">
          A private <code>sources.html</code> page for logging your source evidence for each published claim. Password-protected, never indexed, never linked publicly. Use the same password system as the private view. Each entry: claim ‚Üí source type ‚Üí date accessed ‚Üí reliability rating ‚Üí storage location.
          <div><span class="step-status required">Pending Creation ‚Äî Use Button Below</span></div>
        </div>
      </div>
    </div>

    <button class="checker-btn" style="margin-top:16px;" onclick="alert('Sources log generation coming ‚Äî will create sources.html in this directory.')">üìã Create sources.html</button>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 6: ANALYTICS ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-analytics">

    <!-- ‚îÄ‚îÄ MISSION PHASE INDICATOR ‚îÄ‚îÄ -->
    <div style="margin-bottom:20px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <span style="font-size:0.5rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);">Theory of Change ‚Äî Current Phase</span>
        <span id="phase-label" style="font-size:0.5rem;color:var(--gold);letter-spacing:1px;text-transform:uppercase;">Phase 1: Awareness</span>
      </div>
      <div class="phase-bar">
        <div class="phase-seg p1" id="phase-1-bar" style="flex:3;">Awareness</div>
        <div class="phase-seg p2" id="phase-2-bar" style="flex:1;">Material Alt.</div>
        <div class="phase-seg p3" id="phase-3-bar" style="flex:0.5;">Cultural Shift</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ WEEKLY BRIEFING ‚îÄ‚îÄ -->
    <div class="briefing-panel" id="weekly-briefing">
      <div class="briefing-header">
        Weekly Briefing
        <span class="briefing-date" id="briefing-date">‚Äî</span>
      </div>

      <div class="briefing-q">1. Are we growing in the right places?</div>
      <div class="briefing-a" id="brief-1">Sign in with GA4 for live weekly briefing</div>

      <div class="briefing-q">2. Is anyone actually reading?</div>
      <div class="briefing-a" id="brief-2">‚Äî</div>

      <div class="briefing-q">3. What's resonating?</div>
      <div class="briefing-a" id="brief-3">‚Äî</div>

      <div class="briefing-q">4. Are we building trust?</div>
      <div class="briefing-a" id="brief-4">‚Äî</div>

      <div class="briefing-q">5. What should we do next?</div>
      <div class="briefing-a" id="brief-5">‚Äî</div>
    </div>

    <!-- ‚îÄ‚îÄ GA4 API AUTH STRIP ‚îÄ‚îÄ -->
    <div id="ga4-auth-bar" style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:4px;">
      <span style="font-size:0.55rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;flex-shrink:0;">GA4 Live Data</span>
      <span id="ga4-auth-status" style="font-size:0.6rem;color:#f87171;">‚óè Offline ‚Äî sign in for live metrics</span>
      <div style="flex:1;"></div>
      <input class="anl-input" id="inp-property-id" placeholder="GA4 Property ID (numeric)" style="width:180px;margin:0;font-size:0.6rem;padding:5px 10px;" />
      <button id="ga4-signin-btn" class="anl-save-btn" style="margin:0;" onclick="ga4SignIn()">Sign in with Google</button>
      <button id="ga4-refresh-btn" class="refresh-btn" style="display:none;" onclick="ga4Refresh()">‚Üª Refresh</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 1: REACH & AWARENESS
         "Are people finding the content?"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      1 ‚Äî Reach &amp; Awareness
      <span class="sect-badge">Are people finding the content?</span>
    </div>

    <div class="stat-grid" style="margin-bottom:20px;">
      <div class="stat-card"><div class="sc-label">Total Users</div><div class="sc-val" id="m-users">‚Äî</div><div class="sc-sub" id="m-users-sub">last 28 days</div></div>
      <div class="stat-card green"><div class="sc-label">New Users</div><div class="sc-val" id="m-new-users">‚Äî</div><div class="sc-sub">first-time visitors</div></div>
      <div class="stat-card gold"><div class="sc-label">Returning Users</div><div class="sc-val" id="m-returning">‚Äî</div><div class="sc-sub">came back for more</div></div>
      <div class="stat-card blue"><div class="sc-label">Sessions</div><div class="sc-val" id="m-sessions">‚Äî</div><div class="sc-sub">total visits</div></div>
      <div class="stat-card purple"><div class="sc-label">Sri Lanka</div><div class="sc-val" id="m-sl-pct">‚Äî</div><div class="sc-sub">% of traffic from SL</div></div>
      <div class="stat-card"><div class="sc-label">Page Views</div><div class="sc-val" id="m-pageviews">‚Äî</div><div class="sc-sub">all pages combined</div></div>
    </div>

    <!-- Top Pages -->
    <div class="anl-grid" style="margin-bottom:24px;">
      <div class="anl-card">
        <div class="anl-card-title"><span>üìÑ</span> Top Pages (by users)</div>
        <div id="m-top-pages" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
      <div class="anl-card">
        <div class="anl-card-title"><span>üåç</span> Top Countries</div>
        <div id="m-top-countries" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 2: ENGAGEMENT & DEPTH
         "Are they actually reading?"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      2 ‚Äî Engagement &amp; Depth
      <span class="sect-badge">Are they actually reading?</span>
    </div>

    <div class="stat-grid" style="margin-bottom:20px;">
      <div class="stat-card gold"><div class="sc-label">Avg Engaged Time</div><div class="sc-val" id="m-avg-time">‚Äî</div><div class="sc-sub">per session</div></div>
      <div class="stat-card green"><div class="sc-label">Deep Readers</div><div class="sc-val" id="m-deep-readers">‚Äî</div><div class="sc-sub">scrolled ‚â•75% of page</div></div>
      <div class="stat-card"><div class="sc-label">Pages / Session</div><div class="sc-val" id="m-pps">‚Äî</div><div class="sc-sub">avg pages viewed</div></div>
      <div class="stat-card blue"><div class="sc-label">5-Min Readers</div><div class="sc-val" id="m-5min">‚Äî</div><div class="sc-sub">stayed 5+ minutes</div></div>
    </div>

    <div class="anl-grid" style="margin-bottom:24px;">
      <div class="anl-card">
        <div class="anl-card-title"><span>üìä</span> Scroll Depth Distribution</div>
        <div id="m-scroll-dist" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
      <div class="anl-card">
        <div class="anl-card-title"><span>üïí</span> Read Time Distribution</div>
        <div id="m-read-dist" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 3: RESONANCE & IMPACT
         "Is it making people think?"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      3 ‚Äî Resonance &amp; Impact
      <span class="sect-badge">Is it making people think?</span>
    </div>

    <div class="stat-grid" style="margin-bottom:20px;">
      <div class="stat-card green"><div class="sc-label">Return Rate</div><div class="sc-val" id="m-return-rate">‚Äî</div><div class="sc-sub">% returning visitors</div></div>
      <div class="stat-card gold"><div class="sc-label">Share Clicks</div><div class="sc-val" id="m-shares">‚Äî</div><div class="sc-sub">social share actions</div></div>
      <div class="stat-card"><div class="sc-label">Comments</div><div class="sc-val" id="m-comments">‚Äî</div><div class="sc-sub">submitted</div></div>
      <div class="stat-card purple"><div class="sc-label">Sinhala Usage</div><div class="sc-val" id="m-sinhala">‚Äî</div><div class="sc-sub">language toggles to SI</div></div>
      <div class="stat-card blue"><div class="sc-label">Mindmap Clicks</div><div class="sc-val" id="m-mindmap">‚Äî</div><div class="sc-sub">network explored</div></div>
      <div class="stat-card"><div class="sc-label">Cross-Dossier Nav</div><div class="sc-val" id="m-crossnav">‚Äî</div><div class="sc-sub">explored other dossiers</div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 4: AUDIENCE PROFILE
         "Who is engaging?"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      4 ‚Äî Audience Profile
      <span class="sect-badge">Who is engaging?</span>
    </div>

    <div class="anl-grid" style="margin-bottom:24px;">
      <div class="anl-card">
        <div class="anl-card-title"><span>üì±</span> Device Split</div>
        <div id="m-devices" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
      <div class="anl-card">
        <div class="anl-card-title"><span>üîó</span> Traffic Sources</div>
        <div id="m-sources" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 4B: AUDIENCE INTELLIGENCE
         "Strategic demographic signals"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      4b ‚Äî Audience Intelligence
      <span class="sect-badge">Strategic demographic signals</span>
    </div>

    <div class="stat-grid" style="margin-bottom:20px;">
      <div class="stat-card gold"><div class="sc-label">Android %</div><div class="sc-val" id="m-android">‚Äî</div><div class="sc-sub">income proxy ‚Äî Android dominant = beyond elite</div></div>
      <div class="stat-card blue"><div class="sc-label">iOS %</div><div class="sc-val" id="m-ios">‚Äî</div><div class="sc-sub">higher income bracket</div></div>
      <div class="stat-card green"><div class="sc-label">Diaspora %</div><div class="sc-val" id="m-diaspora-pct">‚Äî</div><div class="sc-sub">UAE, UK, AU, CA, SG, KR, JP, IT</div></div>
      <div class="stat-card purple"><div class="sc-label">Colombo vs Rest</div><div class="sc-val" id="m-colombo-ratio">‚Äî</div><div class="sc-sub">geographic concentration</div></div>
    </div>

    <div class="anl-grid" style="margin-bottom:24px;">
      <div class="anl-card">
        <div class="anl-card-title"><span>üåè</span> Diaspora Breakdown</div>
        <div id="m-diaspora-detail" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
      </div>
      <div class="anl-card">
        <div class="anl-card-title"><span>üïê</span> Access Time Patterns</div>
        <div id="m-access-hours" style="font-size:0.62rem;color:var(--muted2);">Sign in for live data</div>
        <div style="font-size:0.48rem;color:var(--muted);margin-top:8px;">Evening (6pm-11pm) = working people ¬∑ Daytime = professionals/diaspora</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 5: CREDIBILITY & TRUST
         "Are we building long-term legitimacy?"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      5 ‚Äî Credibility &amp; Trust
      <span class="sect-badge">Building long-term legitimacy</span>
    </div>

    <div class="cred-grid">
      <div class="cred-card trust">
        <div class="cred-label">Direct Traffic Ratio</div>
        <div class="cred-val" id="m-direct-ratio">‚Äî</div>
        <div class="cred-sub">people type your URL ‚Äî brand recognition</div>
        <div class="cred-trend flat" id="m-direct-trend">‚Äî</div>
      </div>
      <div class="cred-card trust">
        <div class="cred-label">Return Visit Frequency</div>
        <div class="cred-val" id="m-return-freq">‚Äî</div>
        <div class="cred-sub">avg sessions per returning user</div>
        <div class="cred-trend flat" id="m-return-trend">‚Äî</div>
      </div>
      <div class="cred-card growth">
        <div class="cred-label">Source Verification Rate</div>
        <div class="cred-val" id="m-source-verify">‚Äî</div>
        <div class="cred-sub">% who click external source links</div>
        <div class="cred-trend flat" id="m-verify-trend">‚Äî</div>
      </div>
      <div class="cred-card growth">
        <div class="cred-label">Organic Search %</div>
        <div class="cred-val" id="m-organic-pct">‚Äî</div>
        <div class="cred-sub">Google trusts you enough to rank you</div>
        <div class="cred-trend flat" id="m-organic-trend">‚Äî</div>
      </div>
    </div>

    <div class="info-box" style="margin-bottom:24px;">
      <strong>Credibility compound effect:</strong> Direct traffic + return visits + source clicks = people trust your work enough to come back, verify independently, and share with their own name attached. This is the foundation for Phase 2 (material alternatives). Track these monthly ‚Äî they should trend upward consistently.
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 6: RISK SIGNALS
         "Chess-player board awareness"
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sect-title" style="font-size:1.1rem;">
      6 ‚Äî Risk Signals
      <span class="sect-badge">Chess-player board awareness</span>
    </div>

    <div id="risk-signals-container">
      <div class="risk-signal" id="risk-traffic-spike">
        <span class="risk-icon">üìà</span>
        <div class="risk-info">
          <div class="risk-name">Traffic Spike Detection</div>
          <div class="risk-desc">Sudden traffic surge from unusual sources ‚Äî could indicate state monitoring, viral share, or coordinated campaign</div>
        </div>
        <span class="risk-val" id="risk-spike-val">‚Äî</span>
      </div>
      <div class="risk-signal" id="risk-sl-drop">
        <span class="risk-icon">üîª</span>
        <div class="risk-info">
          <div class="risk-name">Sri Lanka Traffic Drop</div>
          <div class="risk-desc">Sudden decline in SL traffic could indicate ISP blocking or domain interference ‚Äî verify via VPN</div>
        </div>
        <span class="risk-val" id="risk-sl-drop-val">‚Äî</span>
      </div>
      <div class="risk-signal" id="risk-bounce">
        <span class="risk-icon">üö™</span>
        <div class="risk-info">
          <div class="risk-name">Admin Page Probing</div>
          <div class="risk-desc">Unusual access attempts on analytics.html, sources.html, or non-public paths</div>
        </div>
        <span class="risk-val" id="risk-probe-val">‚Äî</span>
      </div>
      <div class="risk-signal" id="risk-referrer">
        <span class="risk-icon">üîó</span>
        <div class="risk-info">
          <div class="risk-name">Hostile Referral Sources</div>
          <div class="risk-desc">Traffic from sites known for harassment campaigns or doxxing</div>
        </div>
        <span class="risk-val" id="risk-referrer-val">‚Äî</span>
      </div>
    </div>

    <div class="info-box gold" style="margin-top:16px;margin-bottom:24px;">
      <strong>The cardinal rule:</strong> Never publish anything you cannot defend in the worst-case scenario. These signals exist so you see the board clearly. Green = normal. Gold = watch. Red = act. Review risk signals before every publish.
    </div>

    <!-- ‚îÄ‚îÄ CONFIGURATION & LINKS ‚îÄ‚îÄ -->
    <div style="border-top:1px solid var(--border);padding-top:20px;margin-top:8px;">
      <div class="sect-title" style="font-size:0.9rem;">Configuration &amp; Dashboards</div>
    </div>

    <div class="anl-grid" style="margin-bottom:16px;">
      <div class="anl-card">
        <div class="anl-card-title"><span>‚öôÔ∏è</span> Active Tracking IDs</div>
        <div class="anl-id-row"><span class="anl-id-label">GA4 Measurement ID</span><span class="anl-id-val live" id="anl-ga4-display">G-SCKES76007</span></div>
        <div class="anl-id-row"><span class="anl-id-label">Clarity Project ID</span><span class="anl-id-val live" id="anl-clarity-display">vomuhyeriq</span></div>
        <div class="anl-id-row"><span class="anl-id-label">GDPR-Aware</span><span class="anl-id-val live">‚úì Yes ‚Äî skips on declined consent</span></div>
        <div class="anl-id-row"><span class="anl-id-label">Custom Events</span><span class="anl-id-val live">‚úì 10 event types across 8 pages</span></div>
        <div class="anl-id-row"><span class="anl-id-label">IP Anonymisation</span><span class="anl-id-val live">‚úì anonymize_ip: true</span></div>
      </div>
      <div class="anl-card">
        <div class="anl-card-title"><span>üîó</span> External Dashboards</div>
        <div class="dash-links">
          <a class="dash-link" href="https://analytics.google.com" target="_blank" rel="noopener">
            <span class="dash-link-icon">üìà</span>
            <div class="dash-link-info"><div class="dash-link-title">GA4 Dashboard</div><div class="dash-link-desc">Full reports, segments, custom explorations</div></div>
          </a>
          <a class="dash-link" href="https://clarity.microsoft.com" target="_blank" rel="noopener">
            <span class="dash-link-icon">üñ•Ô∏è</span>
            <div class="dash-link-info"><div class="dash-link-title">Clarity Dashboard</div><div class="dash-link-desc">Heatmaps, session recordings, scroll maps</div></div>
          </a>
          <a class="dash-link" href="https://analytics.google.com/analytics/web/#/realtime" target="_blank" rel="noopener">
            <span class="dash-link-icon">‚ö°</span>
            <div class="dash-link-info"><div class="dash-link-title">GA4 Real-time</div><div class="dash-link-desc">Who's on the site right now</div></div>
          </a>
          <a class="dash-link" href="https://search.google.com/search-console" target="_blank" rel="noopener">
            <span class="dash-link-icon">üîç</span>
            <div class="dash-link-info"><div class="dash-link-title">Search Console</div><div class="dash-link-desc">Impressions, clicks, ranking keywords</div></div>
          </a>
        </div>
      </div>
    </div>

    <!-- CUSTOM EVENTS REFERENCE -->
    <div class="anl-coverage-wrap">
      <div class="sect-title" style="font-size:0.9rem;margin-bottom:14px;">Custom Events Being Tracked</div>
      <table class="coverage-table">
        <thead><tr><th>Event</th><th>What It Measures</th><th>Why It Matters</th></tr></thead>
        <tbody>
          <tr><td><code>scroll_depth</code></td><td>25%, 50%, 75%, 90%, 100% scroll milestones</td><td>Are readers finishing dossiers or dropping off?</td></tr>
          <tr><td><code>engaged_read_time</code></td><td>30s, 1min, 2min, 5min, 10min time-on-page</td><td>Separates deep readers from skimmers</td></tr>
          <tr><td><code>section_view</code></td><td>Which chapter/section was scrolled to</td><td>Most compelling chapters vs. ignored sections</td></tr>
          <tr><td><code>share_click</code></td><td>Facebook, Twitter, WhatsApp, Telegram shares</td><td>Organic amplification of investigations</td></tr>
          <tr><td><code>language_toggle</code></td><td>EN‚ÜíSI / SI‚ÜíEN switches</td><td>Sinhala audience reach, content accessibility</td></tr>
          <tr><td><code>mindmap_interact</code></td><td>Node clicks, link clicks, embed copies</td><td>Network map engagement, viral embeddability</td></tr>
          <tr><td><code>comment_submit</code></td><td>Comment form submissions</td><td>Community participation, public discourse</td></tr>
          <tr><td><code>outbound_click</code></td><td>Clicks to external source links</td><td>Readers verifying claims ‚Äî critical thinking signal</td></tr>
          <tr><td><code>cross_dossier_nav</code></td><td>Navigating between dossiers</td><td>Broader curiosity, system-level awareness</td></tr>
          <tr><td><code>page_exit</code></td><td>Final scroll% + read time on leave</td><td>True completion metrics per visit</td></tr>
        </tbody>
      </table>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê TAB 7: SEO / AEO ‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-panel" id="tab-seo">
    <div class="info-box gold">
      <strong>SEO + AEO Strategy:</strong> analyst.rizrazak.com targets investigative journalism keywords and Sri Lanka-specific political/sports searches. AEO (Answer Engine Optimisation) targets AI assistants (ChatGPT, Perplexity, Claude) that increasingly surface investigative content as cited sources.
    </div>

    <div class="sect-title" style="font-size:1rem;margin-bottom:16px;">Technical SEO</div>

    <div class="seo-item done">
      <div class="seo-title">‚úÖ Open Graph + Twitter Cards</div>
      <div class="seo-body">All dossier pages have <code>og:title</code>, <code>og:description</code>, <code>og:image</code>, <code>twitter:card</code>. Social sharing previews are configured. Update <code>og:image</code> per dossier for best click-through.</div>
    </div>
    <div class="seo-item done">
      <div class="seo-title">‚úÖ Meta Descriptions</div>
      <div class="seo-body">Each page has a unique <code>meta description</code>. Keep these under 155 characters and include primary keywords.</div>
    </div>
    <div class="seo-item wip">
      <div class="seo-title">‚ö†Ô∏è Sitemap ‚Äî Pending</div>
      <div class="seo-body">No <code>sitemap.xml</code> exists yet. Create one listing all public dossier URLs and submit to Google Search Console. Also create <code>robots.txt</code> pointing to the sitemap and blocking <code>/analytics.html</code> and <code>/sources.html</code>.</div>
    </div>
    <div class="seo-item wip">
      <div class="seo-title">‚ö†Ô∏è Canonical URLs</div>
      <div class="seo-body">Add <code>&lt;link rel="canonical" href="[full URL]"&gt;</code> to each page to prevent duplicate content penalties if the page is ever mirrored or crawled via multiple paths.</div>
    </div>
    <div class="seo-item todo">
      <div class="seo-title">‚¨ú Structured Data (JSON-LD)</div>
      <div class="seo-body">Add <code>NewsArticle</code> or <code>Article</code> schema markup to each dossier. This tells Google and AI assistants that the content is structured journalism. Increases chances of appearing as a cited source in AI answers. Example: author, publisher, datePublished, headline, description, articleBody summary.</div>
    </div>
    <div class="seo-item todo">
      <div class="seo-title">‚¨ú AEO: AI Citation Optimisation</div>
      <div class="seo-body">To be cited by Perplexity, ChatGPT, and Claude: (1) Ensure pages are crawlable ‚Äî no JS-only rendering for key content. (2) Add factual, cited claim summaries at the top of each dossier. (3) Use precise entity names (Shammi Silva, Sri Lanka Cricket, 1xbet) in headings ‚Äî AI models match entity names. (4) Create a <code>citations.html</code> page listing all primary sources with full URLs ‚Äî AI models use source density as a quality signal.</div>
    </div>
    <div class="seo-item todo">
      <div class="seo-title">‚¨ú Internal Linking</div>
      <div class="seo-body">Ensure every dossier page links back to the homepage and to related dossiers. The mindmap embed already provides cross-linking. Consider a global "Related Investigations" footer section across all dossier pages.</div>
    </div>
    <div class="seo-item todo">
      <div class="seo-title">‚¨ú Page Speed</div>
      <div class="seo-body">Run <a href="https://pagespeed.web.dev" target="_blank">PageSpeed Insights</a> on each dossier. Key targets: LCP &lt; 2.5s, CLS &lt; 0.1, FID &lt; 100ms. Dossier pages use heavy CSS/JS ‚Äî consider deferring non-critical scripts. GA4 and Clarity load async and won't block render.</div>
    </div>

    <button class="checker-btn" style="margin-top:16px;" onclick="generateSitemap()">üó∫ Generate sitemap.xml</button>
    <button class="checker-btn" style="margin-top:16px;margin-left:10px;background:var(--blue);" onclick="generateRobotsTxt()">ü§ñ Generate robots.txt</button>
  </div>

</div>

<script>
// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
setInterval(()=>{
  document.getElementById('clock').textContent = new Date().toLocaleString('en-GB',{
    day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit'
  });
}, 1000);

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('active', t.dataset.tab===name);
  });
  document.querySelectorAll('.tab-panel').forEach(p=>{
    p.classList.toggle('active', p.id==='tab-'+name);
  });
  if(name==='comments')  loadDashboard();
  if(name==='gdpr')      loadGdprPanel();
  if(name==='analytics') loadAnalyticsIds();
}

// ‚îÄ‚îÄ STORAGE KEYS ‚îÄ‚îÄ
const PAGE_KEY = 'slc_comments_v1';
const APPROVED_KEY = 'slc_approved_ids_v1';
const GDPR_KEY = 'gdpr_consent_v1';
const TOS_KEY = 'tos_accepted_v1';

// ‚îÄ‚îÄ HASH ‚îÄ‚îÄ
function hashStr(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h*0x01000193)>>>0;
  }
  return 'sha:' + h.toString(16).padStart(8,'0');
}

// ‚îÄ‚îÄ LOAD COMMENTS FROM BOTH KEYS ‚îÄ‚îÄ
function getAllComments(){
  try{
    const arr = JSON.parse(localStorage.getItem(PAGE_KEY)||'[]');
    const approvedIds = JSON.parse(localStorage.getItem(APPROVED_KEY)||'[]');
    // Sync approved IDs back to comment objects
    return arr.map(c => ({
      ...c,
      status: approvedIds.includes(c.id) ? 'approved' :
              (c.status === 'rejected' ? 'rejected' :
               (c.status === 'flagged' ? 'flagged' : 'pending'))
    }));
  } catch(e){ return []; }
}

function saveComments(arr){
  localStorage.setItem(PAGE_KEY, JSON.stringify(arr.slice(0,200)));
}

function getApprovedIds(){
  try{ return JSON.parse(localStorage.getItem(APPROVED_KEY)||'[]'); }
  catch(e){ return []; }
}

function saveApprovedIds(ids){
  localStorage.setItem(APPROVED_KEY, JSON.stringify(ids));
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ
function approveComment(id){
  const arr = getAllComments();
  const ids = getApprovedIds();
  if(!ids.includes(id)) ids.push(id);
  saveApprovedIds(ids);
  // Update status in main array
  const updated = arr.map(c => c.id === id ? {...c, status:'approved'} : c);
  saveComments(updated);
  loadDashboard();
}

function rejectComment(id){
  const arr = getAllComments();
  const ids = getApprovedIds().filter(i=>i!==id);
  saveApprovedIds(ids);
  const updated = arr.map(c => c.id === id ? {...c, status:'rejected'} : c);
  saveComments(updated);
  loadDashboard();
}

function flagComment(id){
  const arr = getAllComments();
  const ids = getApprovedIds().filter(i=>i!==id);
  saveApprovedIds(ids);
  const updated = arr.map(c => c.id === id ? {...c, status:'flagged', flagged:true} : c);
  saveComments(updated);
  loadDashboard();
}

function unapproveComment(id){
  const arr = getAllComments();
  const ids = getApprovedIds().filter(i=>i!==id);
  saveApprovedIds(ids);
  const updated = arr.map(c => c.id === id ? {...c, status:'pending'} : c);
  saveComments(updated);
  loadDashboard();
}

function approveAllPending(){
  const arr = getAllComments();
  const pending = arr.filter(c=>c.status==='pending');
  if(pending.length===0){ alert('No pending comments.'); return; }
  if(!confirm(`Approve all ${pending.length} pending comments?`)) return;
  const ids = getApprovedIds();
  pending.forEach(c=>{ if(!ids.includes(c.id)) ids.push(c.id); });
  saveApprovedIds(ids);
  const updated = arr.map(c => ids.includes(c.id) ? {...c, status:'approved'} : c);
  saveComments(updated);
  loadDashboard();
}

// ‚îÄ‚îÄ FILTER STATE ‚îÄ‚îÄ
let currentFilter = 'all';
function setFilter(f, btn){
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCommentList();
}

// ‚îÄ‚îÄ RENDER COMMENTS ‚îÄ‚îÄ
function renderCommentList(){
  const all = getAllComments();
  const filtered = currentFilter==='all' ? all : all.filter(c=>c.status===currentFilter);
  const list = document.getElementById('comment-list');

  if(filtered.length===0){
    list.innerHTML=`<div class="empty-state"><span class="icon">üí¨</span>${currentFilter==='all'?'No comments yet.':'No '+currentFilter+' comments.'}</div>`;
    return;
  }

  list.innerHTML = filtered.map(c=>{
    const d = new Date(c.ts);
    const ts = d.toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    const tos = c.tos_accepted ? '<span class="cc-tos">ToS Accepted</span>' : '';
    const actionBtns = c.status === 'pending'
      ? `<button class="cc-btn approve" onclick="approveComment('${c.id}')">‚úì Approve</button>
         <button class="cc-btn flag" onclick="flagComment('${c.id}')">üö© Flag</button>
         <button class="cc-btn reject" onclick="rejectComment('${c.id}')">‚úï Reject</button>`
      : c.status === 'approved'
      ? `<button class="cc-btn unapprove" onclick="unapproveComment('${c.id}')">‚Ü© Unapprove</button>
         <button class="cc-btn flag" onclick="flagComment('${c.id}')">üö© Flag</button>`
      : c.status === 'flagged'
      ? `<button class="cc-btn approve" onclick="approveComment('${c.id}')">‚úì Approve</button>
         <button class="cc-btn reject" onclick="rejectComment('${c.id}')">‚úï Reject</button>`
      : `<button class="cc-btn approve" onclick="approveComment('${c.id}')">‚Ü© Restore</button>`;

    return `<div class="cc ${c.status||'pending'}">
      <div class="cc-header">
        <div class="cc-meta">
          <span class="cc-id">#${c.id}</span>
          <span class="cc-status ${c.status||'pending'}">${(c.status||'pending').toUpperCase()}</span>
          <span class="cc-time">${ts}</span>
          ${tos}
        </div>
        <div class="cc-actions">${actionBtns}</div>
      </div>
      <div class="cc-text">${escHtml(c.text||'')}</div>
      <div class="cc-detail">
        <span><span class="cc-ip">${escHtml(c.ip||'unknown')}</span></span>
        <span class="cc-geo">üìç ${escHtml(c.geo||'Unknown')}</span>
        <span>üîë Hash: ${c.ip_hash||hashStr(c.ip||'')}</span>
        <span>üåê ${escHtml((c.ua||'').slice(0,60))}</span>
      </div>
    </div>`;
  }).join('');
}

function escHtml(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// ‚îÄ‚îÄ LOAD DASHBOARD ‚îÄ‚îÄ
function loadDashboard(){
  const all = getAllComments();
  const pending = all.filter(c=>c.status==='pending').length;
  const approved = all.filter(c=>c.status==='approved').length;
  const flagged = all.filter(c=>c.status==='flagged').length;

  document.getElementById('sc-total').textContent = all.length;
  document.getElementById('sc-pending').textContent = pending;
  document.getElementById('sc-approved').textContent = approved;
  document.getElementById('sc-flagged').textContent = flagged;
  document.getElementById('tab-pending-count').textContent = pending;
  document.getElementById('tab-pending-count').className = 'tab-badge' + (pending > 0 ? ' gold' : ' green');

  // ToS
  const tos = localStorage.getItem(TOS_KEY);
  document.getElementById('sc-tos').textContent = tos ? '‚úì YES' : '‚úó NO';
  document.getElementById('sc-tos').style.color = tos ? '#34d399' : '#f87171';

  // GDPR
  const gdpr = localStorage.getItem(GDPR_KEY);
  if(gdpr){
    const g = JSON.parse(gdpr);
    document.getElementById('sc-gdpr').textContent = g.accepted ? '‚úì Accepted' : '‚úó Declined';
    document.getElementById('sc-gdpr').style.color = g.accepted ? '#34d399' : '#fbbf24';
  } else {
    document.getElementById('sc-gdpr').textContent = 'NOT SET';
    document.getElementById('sc-gdpr').style.color = '#f87171';
  }

  renderCommentList();
}

// ‚îÄ‚îÄ GDPR PANEL ‚îÄ‚îÄ
function loadGdprPanel(){
  const all = getAllComments();
  const gdpr = localStorage.getItem(GDPR_KEY);
  const tos = localStorage.getItem(TOS_KEY);

  // GDPR consent
  if(gdpr){
    const g = JSON.parse(gdpr);
    document.getElementById('gd-consent').textContent = g.accepted ? '‚úì ACCEPTED' : '‚úó DECLINED';
    document.getElementById('gd-consent').className = 'gdpr-val ' + (g.accepted ? 'ok' : 'warn');
    document.getElementById('gd-consent-ts').textContent = new Date(g.ts).toLocaleString('en-GB');
  } else {
    document.getElementById('gd-consent').textContent = 'NOT RECORDED';
    document.getElementById('gd-consent').className = 'gdpr-val err';
    document.getElementById('gd-consent-ts').textContent = '‚Äî';
  }

  // ToS
  if(tos){
    const t = JSON.parse(tos);
    document.getElementById('gd-tos').textContent = '‚úì ACCEPTED v' + (t.version||'1.0');
    document.getElementById('gd-tos').className = 'gdpr-val ok';
    document.getElementById('gd-tos-ts').textContent = new Date(t.ts).toLocaleString('en-GB');
  } else {
    document.getElementById('gd-tos').textContent = 'NOT RECORDED';
    document.getElementById('gd-tos').className = 'gdpr-val warn';
    document.getElementById('gd-tos-ts').textContent = '‚Äî';
  }

  // Raw IPs
  const rawIps = all.filter(c=>c.ip && !c.ip.startsWith('sha:') && c.ip!=='DECLINED' && c.ip!=='unknown').length;
  document.getElementById('gd-ip-raw').textContent = rawIps + ' comment(s) with raw IP';
  document.getElementById('gd-ip-raw').className = 'gdpr-val ' + (rawIps > 0 ? 'warn' : 'ok');

  // 90-day purge
  const oldest = all.reduce((min,c)=>Math.min(min,c.ts||Date.now()), Date.now());
  const ninetyDays = 90*24*60*60*1000;
  const purgeDue = new Date(oldest + ninetyDays);
  document.getElementById('gd-purge').textContent = all.length > 0 ? purgeDue.toLocaleDateString('en-GB') : 'No data';

  document.getElementById('gd-total').textContent = all.length;
}

// ‚îÄ‚îÄ GDPR ACTIONS ‚îÄ‚îÄ
function purgeRawIPs(){
  const arr = getAllComments();
  const updated = arr.map(c=>{
    if(c.ip && !c.ip.startsWith('sha:') && c.ip !== 'DECLINED' && c.ip !== 'unknown'){
      return {...c, ip: hashStr(c.ip + 'salt_slc_2026'), ip_hashed_at: Date.now()};
    }
    return c;
  });
  saveComments(updated);
  alert('‚úì All raw IPs replaced with hashes. This is irreversible.');
  loadGdprPanel();
}

function purgeOldComments(){
  const arr = getAllComments();
  const cutoff = Date.now() - 90*24*60*60*1000;
  const kept = arr.filter(c=>(c.ts||0) > cutoff);
  if(kept.length === arr.length){ alert('No comments older than 90 days.'); return; }
  if(!confirm(`Delete ${arr.length - kept.length} comment(s) older than 90 days?`)) return;
  saveComments(kept);
  alert(`‚úì Deleted ${arr.length - kept.length} old comment(s).`);
  loadGdprPanel();
}

function exportComments(){
  const arr = getAllComments();
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `slc-comments-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ ALLEGED CHECKER ‚îÄ‚îÄ
const NAMED_PEOPLE = [
  'Gunathilaka','Danushka','Dickwella','Kusal','Hasaranga','Shanaka','Chandimal',
  'Thirimanne','Mendis','de Silva','Mathews','Perera','Fernando','Rajapaksa',
  'Jayasuriya','Murali','Muralitharan','Ranatunga','Hathurusingha','Pothas',
  'Kalathma','Hitihamige','Angelo','Dimuth','Suranga','Lahiru','Niroshan',
  'Thisara','Asela','Dhananjaya','Binura','Kasun','Praveen'
];

const COMPLIANCE_LABELS = [
  'alleged','allegedly','allegation','reportedly','reported','unverified',
  'confirmed','according to','sources say','claimed','claims','understood',
  'believed','accused','appears to','said to','suspected'
];

function runChecker(){
  const input = document.getElementById('checker-input').value.trim();
  if(!input){ alert('Paste some text first.'); return; }
  analyseText(input);
}

function scanFullPage(){
  // Try to fetch the case file
  const out = document.getElementById('checker-output');
  out.innerHTML = '<div style="color:var(--muted);font-size:0.65rem;padding:12px;">Loading case file for scan...</div>';
  fetch('kalathma-scandal.html')
    .then(r=>r.text())
    .then(html=>{
      // Strip HTML tags
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      const text = tmp.innerText || tmp.textContent;
      document.getElementById('checker-input').value = text.slice(0,5000); // first 5k chars
      analyseText(text);
    })
    .catch(()=>{
      out.innerHTML = '<div style="color:#f87171;font-size:0.65rem;padding:12px;">Could not fetch page. Use the paste method instead.</div>';
    });
}

function clearChecker(){
  document.getElementById('checker-input').value = '';
  document.getElementById('checker-output').innerHTML = '';
}

function analyseText(text){
  const out = document.getElementById('checker-output');

  // Split into sentences
  const sentences = text.match(/[^.!?\n]+[.!?\n]?/g) || [text];
  const results = [];
  let issues = 0;

  sentences.forEach(sent=>{
    const s = sent.trim();
    if(s.length < 20) return;

    // Pass 1: Does this sentence name a person?
    const namedPerson = NAMED_PEOPLE.find(n=>s.includes(n));
    if(!namedPerson) return;

    // Pass 2: Does it have a compliance label?
    const hasLabel = COMPLIANCE_LABELS.some(l=>s.toLowerCase().includes(l));

    // Is it a factual assertion (not a question or block quote)?
    const isAssertion = !s.includes('\u201C') && !s.includes('\u2018') && !s.startsWith('\u2013') && !s.startsWith('\u2014');

    if(!hasLabel && isAssertion){
      issues++;
      results.push({type:'err', text: s, person: namedPerson, note:'Missing compliance label ‚Äî could be read as established fact'});
    } else if(hasLabel){
      results.push({type:'ok', text: s, person: namedPerson, note:'‚úì Compliance label present'});
    }
  });

  if(results.length === 0){
    out.innerHTML = `<div class="checker-summary">‚úì No named-person assertions found in this text, or no compliance issues detected.</div>`;
    return;
  }

  const summaryClass = issues > 0 ? 'issues' : '';
  const summary = issues > 0
    ? `‚ö†Ô∏è Found <strong>${issues} assertion${issues>1?'s':''}</strong> about named individuals without compliance labels. Review before publishing.`
    : `‚úì All <strong>${results.length}</strong> named-person assertions have compliance labels. Good to publish.`;

  out.innerHTML = `<div class="checker-summary ${summaryClass}">${summary}</div>` +
    results.map(r=>`
      <div class="checker-claim ${r.type}">
        <div class="claim-label ${r.type}">${r.type==='ok' ? '‚úì LABELLED' : '‚ö†Ô∏è NEEDS LABEL'} ‚Äî mentions: ${r.person}</div>
        <div class="claim-text">"${escHtml(r.text.slice(0,200))}"</div>
        <div style="font-size:0.5rem;color:var(--muted);margin-top:4px;">${r.note}</div>
        ${r.type==='err' ? `<div style="font-size:0.5rem;color:#fbbf24;margin-top:4px;">üí° Fix: add "allegedly", "reportedly", or "according to [source]" before the claim</div>` : ''}
      </div>
    `).join('');
}

// ‚îÄ‚îÄ GENERATE PAGES ‚îÄ‚îÄ
function generatePrivacyPage(){
  alert('privacy.html generation: coming in next build. For now, copy the content from the legal brief above into privacy.html manually.\n\nKey content:\n- Data collected: IP, user agent, timestamp, comment text\n- Legal basis: Legitimate interest (GDPR Art. 6(1)(f))\n- Retention: 90 days raw IP, then hashed\n- Rights: submit correction request via comments section\n- Jurisdiction: United States');
}

function generateTermsPage(){
  alert('terms.html generation: coming in next build. Key clauses:\n- US jurisdiction\n- User responsibility for comments\n- No guarantee of accuracy for ALLEGED content\n- Right to remove content\n- DMCA contact');
}

// ‚îÄ‚îÄ ANALYTICS IDS ‚îÄ‚îÄ
function loadAnalyticsIds(){
  // IDs are now hardcoded ‚Äî display them
  const ga4El = document.getElementById('anl-ga4-display');
  const clarityEl = document.getElementById('anl-clarity-display');
  if(ga4El){ ga4El.textContent = 'G-SCKES76007'; ga4El.className = 'anl-id-val live'; }
  if(clarityEl){ clarityEl.textContent = 'vomuhyeriq'; clarityEl.className = 'anl-id-val live'; }

  // Load saved property ID
  const propId = localStorage.getItem('ga4_property_id') || '';
  const inp = document.getElementById('inp-property-id');
  if(inp && propId) inp.value = propId;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GA4 DATA API ‚Äî Live metrics via Google Identity Services + Analytics Data API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// To use: Create OAuth2 Web Client ID at console.cloud.google.com
// Enable "Google Analytics Data API" in the same project.
// Then enter your GA4 Property ID (numeric, from GA4 Admin ‚Üí Property Settings).
//
// The OAuth Client ID for analyst.rizrazak.com:
const GA4_OAUTH_CLIENT_ID = localStorage.getItem('ga4_oauth_client_id') || '';
let ga4AccessToken = null;
let ga4PropertyId  = null;

// Load Google Identity Services library
(function(){
  const s = document.createElement('script');
  s.src = 'https://accounts.google.com/gsi/client';
  s.async = true;
  document.head.appendChild(s);
})();

function ga4SignIn(){
  ga4PropertyId = document.getElementById('inp-property-id').value.trim();
  if(!ga4PropertyId){
    alert('Enter your GA4 Property ID first.\n\nFind it at: analytics.google.com ‚Üí Admin ‚Üí Property Settings ‚Üí Property ID (numeric).');
    return;
  }
  localStorage.setItem('ga4_property_id', ga4PropertyId);

  // Use Google Identity Services tokenClient
  if(typeof google === 'undefined' || !google.accounts){
    alert('Google Identity Services not loaded. Check your internet connection.');
    return;
  }

  const tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GA4_OAUTH_CLIENT_ID || prompt('Enter your Google OAuth2 Client ID:\n\n(Create one at console.cloud.google.com ‚Üí APIs & Services ‚Üí Credentials ‚Üí OAuth 2.0 Client ID ‚Üí Web application)\n\nAuthorized JS origins: https://analyst.rizrazak.com'),
    scope: 'https://www.googleapis.com/auth/analytics.readonly',
    callback: (response) => {
      if(response.error){
        document.getElementById('ga4-auth-status').innerHTML = '<span style="color:#f87171;">‚óè Auth failed: ' + response.error + '</span>';
        return;
      }
      ga4AccessToken = response.access_token;
      if(!GA4_OAUTH_CLIENT_ID) localStorage.setItem('ga4_oauth_client_id', tokenClient.s.client_id || '');
      document.getElementById('ga4-auth-status').innerHTML = '<span style="color:#34d399;">‚óè Connected ‚Äî pulling live data‚Ä¶</span>';
      document.getElementById('ga4-refresh-btn').style.display = '';
      ga4Refresh();
    }
  });
  tokenClient.requestAccessToken();
}

async function ga4Refresh(){
  if(!ga4AccessToken || !ga4PropertyId) return;
  document.getElementById('ga4-auth-status').innerHTML = '<span style="color:#fbbf24;">‚óè Fetching‚Ä¶</span>';
  try {
    await Promise.all([
      fetchReachMetrics(),
      fetchEngagementMetrics(),
      fetchResonanceMetrics(),
      fetchAudienceMetrics()
    ]);
    // Second wave ‚Äî depends on first wave for some base data
    await Promise.all([
      fetchAudienceIntelligence(),
      fetchCredibilityMetrics(),
      fetchRiskSignals(),
      generateWeeklyBriefing()
    ]);
    document.getElementById('ga4-auth-status').innerHTML = '<span style="color:#34d399;">‚óè Live ‚Äî updated ' + new Date().toLocaleTimeString() + '</span>';
  } catch(e) {
    document.getElementById('ga4-auth-status').innerHTML = '<span style="color:#f87171;">‚óè Error: ' + e.message + '</span>';
    console.error(e);
  }
}

async function ga4Query(body){
  const url = 'https://analyticsdata.googleapis.com/v1beta/properties/' + ga4PropertyId + ':runReport';
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Authorization': 'Bearer ' + ga4AccessToken, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error('GA4 API ' + res.status + ': ' + (await res.text()).slice(0,200));
  return res.json();
}

function gVal(data, rowIdx, metricIdx){
  try { return data.rows[rowIdx || 0].metricValues[metricIdx || 0].value; } catch(e){ return '0'; }
}
function gDim(data, rowIdx, dimIdx){
  try { return data.rows[rowIdx || 0].dimensionValues[dimIdx || 0].value; } catch(e){ return '‚Äî'; }
}
function fmt(n){ n = parseInt(n||0); return n >= 1000 ? (n/1000).toFixed(1) + 'k' : n.toString(); }
function pct(n,d){ return d > 0 ? Math.round(n/d*100) + '%' : '‚Äî'; }
function secs(s){ s = Math.round(parseFloat(s)||0); return s >= 60 ? Math.floor(s/60) + 'm ' + (s%60) + 's' : s + 's'; }

// ‚îÄ‚îÄ SECTION 1: REACH ‚îÄ‚îÄ
async function fetchReachMetrics(){
  // Main metrics
  const main = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    metrics: [
      { name: 'totalUsers' },
      { name: 'newUsers' },
      { name: 'sessions' },
      { name: 'screenPageViews' }
    ]
  });
  const users = parseInt(gVal(main,0,0));
  const newU  = parseInt(gVal(main,0,1));
  const sess  = parseInt(gVal(main,0,2));
  const pvs   = parseInt(gVal(main,0,3));
  const retU  = Math.max(0, users - newU);

  document.getElementById('m-users').textContent      = fmt(users);
  document.getElementById('m-new-users').textContent   = fmt(newU);
  document.getElementById('m-returning').textContent   = fmt(retU);
  document.getElementById('m-sessions').textContent    = fmt(sess);
  document.getElementById('m-pageviews').textContent   = fmt(pvs);

  // Country breakdown
  const geo = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'country' }],
    metrics: [{ name: 'totalUsers' }],
    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
    limit: 10
  });
  let slUsers = 0;
  let countryHtml = '';
  (geo.rows || []).forEach((r,i) => {
    const country = r.dimensionValues[0].value;
    const count   = parseInt(r.metricValues[0].value);
    if(country === 'Sri Lanka') slUsers = count;
    const bar = Math.round(count / users * 100);
    countryHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span style="width:100px;flex-shrink:0;">' + country + '</span><div style="flex:1;background:var(--border);height:8px;border-radius:4px;"><div style="width:' + bar + '%;background:' + (country==='Sri Lanka'?'var(--gold)':'var(--blue)') + ';height:100%;border-radius:4px;"></div></div><span style="width:40px;text-align:right;">' + fmt(count) + '</span></div>';
  });
  document.getElementById('m-sl-pct').textContent = pct(slUsers, users);
  document.getElementById('m-top-countries').innerHTML = countryHtml || 'No data yet';

  // Top pages
  const pages = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'pageTitle' }],
    metrics: [{ name: 'totalUsers' }, { name: 'averageSessionDuration' }],
    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
    limit: 8
  });
  let pagesHtml = '';
  (pages.rows || []).forEach(r => {
    const title = r.dimensionValues[0].value;
    const count = parseInt(r.metricValues[0].value);
    const avgT  = secs(r.metricValues[1].value);
    const bar   = Math.round(count / users * 100);
    pagesHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="' + escHtml(title) + '">' + escHtml(title.slice(0,50)) + '</span><div style="width:80px;background:var(--border);height:8px;border-radius:4px;"><div style="width:' + bar + '%;background:var(--green);height:100%;border-radius:4px;"></div></div><span style="width:35px;text-align:right;">' + fmt(count) + '</span><span style="width:45px;text-align:right;color:var(--muted);">' + avgT + '</span></div>';
  });
  document.getElementById('m-top-pages').innerHTML = pagesHtml || 'No data yet';
}

// ‚îÄ‚îÄ SECTION 2: ENGAGEMENT ‚îÄ‚îÄ
async function fetchEngagementMetrics(){
  const main = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    metrics: [
      { name: 'averageSessionDuration' },
      { name: 'screenPageViewsPerSession' }
    ]
  });
  document.getElementById('m-avg-time').textContent = secs(gVal(main,0,0));
  document.getElementById('m-pps').textContent = parseFloat(gVal(main,0,1)).toFixed(1);

  // Scroll depth events
  const scroll = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'customEvent:percent' }],
    metrics: [{ name: 'eventCount' }],
    dimensionFilter: { filter: { fieldName: 'eventName', stringFilter: { value: 'scroll_depth' } } }
  });
  let scrollHtml = '';
  let deep = 0, total = 0;
  const scrollData = {};
  (scroll.rows || []).forEach(r => {
    const p = r.dimensionValues[0].value;
    const c = parseInt(r.metricValues[0].value);
    scrollData[p] = c;
    if(parseInt(p) >= 75) deep += c;
    total += c;
  });
  [25, 50, 75, 90, 100].forEach(mark => {
    const c = scrollData[mark] || 0;
    const bar = total > 0 ? Math.round(c/total*100) : 0;
    const color = mark >= 75 ? 'var(--green)' : mark >= 50 ? 'var(--gold)' : 'var(--muted)';
    scrollHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;"><span style="width:35px;">' + mark + '%</span><div style="flex:1;background:var(--border);height:10px;border-radius:4px;"><div style="width:' + bar + '%;background:' + color + ';height:100%;border-radius:4px;"></div></div><span style="width:35px;text-align:right;">' + fmt(c) + '</span></div>';
  });
  document.getElementById('m-scroll-dist').innerHTML = scrollHtml || 'Awaiting scroll_depth events';
  document.getElementById('m-deep-readers').textContent = fmt(deep);

  // Read time events
  const readTime = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'customEvent:seconds' }],
    metrics: [{ name: 'eventCount' }],
    dimensionFilter: { filter: { fieldName: 'eventName', stringFilter: { value: 'engaged_read_time' } } }
  });
  let readHtml = '';
  let fiveMin = 0;
  const readData = {};
  (readTime.rows || []).forEach(r => {
    const s = r.dimensionValues[0].value;
    const c = parseInt(r.metricValues[0].value);
    readData[s] = c;
    if(parseInt(s) >= 300) fiveMin += c;
  });
  const readTotal = Object.values(readData).reduce((a,b) => a+b, 0) || 1;
  [30, 60, 120, 300, 600].forEach(mark => {
    const c = readData[mark] || 0;
    const bar = Math.round(c/readTotal*100);
    const label = mark < 60 ? mark + 's' : (mark/60) + 'min';
    const color = mark >= 300 ? 'var(--green)' : mark >= 120 ? 'var(--gold)' : 'var(--muted)';
    readHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;"><span style="width:40px;">' + label + '</span><div style="flex:1;background:var(--border);height:10px;border-radius:4px;"><div style="width:' + bar + '%;background:' + color + ';height:100%;border-radius:4px;"></div></div><span style="width:35px;text-align:right;">' + fmt(c) + '</span></div>';
  });
  document.getElementById('m-read-dist').innerHTML = readHtml || 'Awaiting engaged_read_time events';
  document.getElementById('m-5min').textContent = fmt(fiveMin);
}

// ‚îÄ‚îÄ SECTION 3: RESONANCE ‚îÄ‚îÄ
async function fetchResonanceMetrics(){
  // Return rate
  const main = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    metrics: [{ name: 'totalUsers' }, { name: 'newUsers' }]
  });
  const users = parseInt(gVal(main,0,0));
  const newU  = parseInt(gVal(main,0,1));
  document.getElementById('m-return-rate').textContent = pct(users - newU, users);

  // Custom events batch
  const events = ['share_click','comment_submit','language_toggle','mindmap_interact','cross_dossier_nav'];
  const evData = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'eventName' }],
    metrics: [{ name: 'eventCount' }],
    dimensionFilter: {
      orGroup: {
        expressions: events.map(e => ({ filter: { fieldName: 'eventName', stringFilter: { value: e } } }))
      }
    }
  });
  const evMap = {};
  (evData.rows || []).forEach(r => { evMap[r.dimensionValues[0].value] = parseInt(r.metricValues[0].value); });

  document.getElementById('m-shares').textContent   = fmt(evMap['share_click'] || 0);
  document.getElementById('m-comments').textContent  = fmt(evMap['comment_submit'] || 0);
  document.getElementById('m-sinhala').textContent   = fmt(evMap['language_toggle'] || 0);
  document.getElementById('m-mindmap').textContent   = fmt(evMap['mindmap_interact'] || 0);
  document.getElementById('m-crossnav').textContent  = fmt(evMap['cross_dossier_nav'] || 0);
}

// ‚îÄ‚îÄ SECTION 4: AUDIENCE ‚îÄ‚îÄ
async function fetchAudienceMetrics(){
  // Devices
  const dev = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'deviceCategory' }],
    metrics: [{ name: 'totalUsers' }],
    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }]
  });
  let devTotal = 0;
  (dev.rows || []).forEach(r => { devTotal += parseInt(r.metricValues[0].value); });
  let devHtml = '';
  const devIcons = { desktop: 'üñ•Ô∏è', mobile: 'üì±', tablet: 'üìã' };
  (dev.rows || []).forEach(r => {
    const cat = r.dimensionValues[0].value;
    const c   = parseInt(r.metricValues[0].value);
    const bar = Math.round(c/devTotal*100);
    devHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;"><span style="width:80px;">' + (devIcons[cat]||'') + ' ' + cat + '</span><div style="flex:1;background:var(--border);height:12px;border-radius:4px;"><div style="width:' + bar + '%;background:var(--gold);height:100%;border-radius:4px;"></div></div><span style="width:50px;text-align:right;">' + bar + '% (' + fmt(c) + ')</span></div>';
  });
  document.getElementById('m-devices').innerHTML = devHtml || 'No data yet';

  // Traffic sources
  const src = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'sessionDefaultChannelGroup' }],
    metrics: [{ name: 'sessions' }],
    orderBys: [{ metric: { metricName: 'sessions' }, desc: true }],
    limit: 8
  });
  let srcTotal = 0;
  (src.rows || []).forEach(r => { srcTotal += parseInt(r.metricValues[0].value); });
  let srcHtml = '';
  const srcColors = { 'Organic Search':'var(--green)', 'Direct':'var(--blue)', 'Organic Social':'var(--gold)', 'Referral':'var(--purple)', 'Paid Search':'var(--orange)' };
  (src.rows || []).forEach(r => {
    const ch  = r.dimensionValues[0].value;
    const c   = parseInt(r.metricValues[0].value);
    const bar = Math.round(c/srcTotal*100);
    srcHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span style="width:110px;white-space:nowrap;">' + ch + '</span><div style="flex:1;background:var(--border);height:8px;border-radius:4px;"><div style="width:' + bar + '%;background:' + (srcColors[ch]||'var(--muted)') + ';height:100%;border-radius:4px;"></div></div><span style="width:50px;text-align:right;">' + bar + '%</span></div>';
  });
  document.getElementById('m-sources').innerHTML = srcHtml || 'No data yet';
}

// ‚îÄ‚îÄ SECTION 4B: AUDIENCE INTELLIGENCE ‚îÄ‚îÄ
async function fetchAudienceIntelligence(){
  // Android vs iOS breakdown
  const os = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'operatingSystem' }],
    metrics: [{ name: 'totalUsers' }],
    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }]
  });
  let osTotal = 0, android = 0, ios = 0;
  (os.rows || []).forEach(r => {
    const name = r.dimensionValues[0].value;
    const c = parseInt(r.metricValues[0].value);
    osTotal += c;
    if(name === 'Android') android = c;
    if(name === 'iOS') ios = c;
  });
  document.getElementById('m-android').textContent = osTotal > 0 ? Math.round(android/osTotal*100) + '%' : '‚Äî';
  document.getElementById('m-ios').textContent = osTotal > 0 ? Math.round(ios/osTotal*100) + '%' : '‚Äî';

  // Diaspora countries
  const DIASPORA = ['United Arab Emirates','United Kingdom','Australia','Canada','Singapore','South Korea','Japan','Italy','United States','Germany','Qatar','Saudi Arabia','Kuwait','New Zealand','France'];
  const geo = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'country' }],
    metrics: [{ name: 'totalUsers' }],
    orderBys: [{ metric: { metricName: 'totalUsers' }, desc: true }],
    limit: 30
  });
  let geoTotal = 0, diasporaTotal = 0, slUsers = 0;
  const diasporaBreakdown = [];
  (geo.rows || []).forEach(r => {
    const country = r.dimensionValues[0].value;
    const c = parseInt(r.metricValues[0].value);
    geoTotal += c;
    if(country === 'Sri Lanka') slUsers = c;
    if(DIASPORA.includes(country)){
      diasporaTotal += c;
      diasporaBreakdown.push({ country, users: c });
    }
  });

  document.getElementById('m-diaspora-pct').textContent = geoTotal > 0 ? Math.round(diasporaTotal/geoTotal*100) + '%' : '‚Äî';
  const nonSL = geoTotal - slUsers;
  document.getElementById('m-colombo-ratio').textContent = geoTotal > 0 ? Math.round(slUsers/geoTotal*100) + '% SL' : '‚Äî';

  // Diaspora detail bars
  let diasHtml = '';
  diasporaBreakdown.sort((a,b) => b.users - a.users).slice(0,8).forEach(d => {
    const bar = diasporaTotal > 0 ? Math.round(d.users/diasporaTotal*100) : 0;
    const flag = {'United Arab Emirates':'üá¶üá™','United Kingdom':'üá¨üáß','Australia':'üá¶üá∫','Canada':'üá®üá¶','Singapore':'üá∏üá¨','South Korea':'üá∞üá∑','Japan':'üáØüáµ','Italy':'üáÆüáπ','United States':'üá∫üá∏','Germany':'üá©üá™','Qatar':'üá∂üá¶','Saudi Arabia':'üá∏üá¶','Kuwait':'üá∞üáº','New Zealand':'üá≥üáø','France':'üá´üá∑'}[d.country] || 'üåê';
    diasHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:5px;"><span style="width:120px;white-space:nowrap;">' + flag + ' ' + d.country + '</span><div style="flex:1;background:var(--border);height:8px;border-radius:4px;"><div style="width:' + bar + '%;background:var(--gold);height:100%;border-radius:4px;"></div></div><span style="width:35px;text-align:right;">' + fmt(d.users) + '</span></div>';
  });
  document.getElementById('m-diaspora-detail').innerHTML = diasHtml || 'No diaspora traffic detected';

  // Access time patterns (hour of day)
  const hours = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'hour' }],
    metrics: [{ name: 'sessions' }],
    orderBys: [{ dimension: { dimensionName: 'hour' } }]
  });
  const hourData = {};
  let hourMax = 0;
  (hours.rows || []).forEach(r => {
    const h = parseInt(r.dimensionValues[0].value);
    const c = parseInt(r.metricValues[0].value);
    hourData[h] = c;
    if(c > hourMax) hourMax = c;
  });
  let hourHtml = '<div style="display:flex;align-items:flex-end;gap:2px;height:60px;margin-bottom:6px;">';
  for(let h = 0; h < 24; h++){
    const c = hourData[h] || 0;
    const pct = hourMax > 0 ? Math.round(c/hourMax*100) : 0;
    const color = (h >= 18 && h <= 23) ? 'var(--gold)' : (h >= 9 && h <= 17) ? 'var(--blue)' : 'var(--muted)';
    hourHtml += '<div style="flex:1;background:' + color + ';height:' + Math.max(pct, 2) + '%;border-radius:2px 2px 0 0;transition:height .3s;" title="' + h + ':00 ‚Äî ' + c + ' sessions"></div>';
  }
  hourHtml += '</div>';
  hourHtml += '<div style="display:flex;justify-content:space-between;font-size:0.42rem;color:var(--muted);"><span>12am</span><span>6am</span><span>12pm</span><span>6pm</span><span>11pm</span></div>';
  // Interpretation
  const eveningSessions = [18,19,20,21,22,23].reduce((s,h) => s + (hourData[h]||0), 0);
  const daySessions = [9,10,11,12,13,14,15,16,17].reduce((s,h) => s + (hourData[h]||0), 0);
  const totalSessions = Object.values(hourData).reduce((s,v) => s+v, 0) || 1;
  const eveningPct = Math.round(eveningSessions/totalSessions*100);
  const dayPct = Math.round(daySessions/totalSessions*100);
  hourHtml += '<div style="margin-top:8px;font-size:0.52rem;color:var(--muted2);">Evening (6-11pm): <span style="color:var(--gold);">' + eveningPct + '%</span> ¬∑ Daytime (9am-5pm): <span style="color:var(--blue);">' + dayPct + '%</span></div>';
  document.getElementById('m-access-hours').innerHTML = hourHtml;
}

// ‚îÄ‚îÄ SECTION 5: CREDIBILITY & TRUST ‚îÄ‚îÄ
async function fetchCredibilityMetrics(){
  // Direct traffic ratio
  const src = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'sessionDefaultChannelGroup' }],
    metrics: [{ name: 'sessions' }]
  });
  let srcTotal = 0, directSessions = 0, organicSessions = 0;
  (src.rows || []).forEach(r => {
    const ch = r.dimensionValues[0].value;
    const c = parseInt(r.metricValues[0].value);
    srcTotal += c;
    if(ch === 'Direct') directSessions = c;
    if(ch === 'Organic Search') organicSessions = c;
  });
  document.getElementById('m-direct-ratio').textContent = srcTotal > 0 ? Math.round(directSessions/srcTotal*100) + '%' : '‚Äî';
  document.getElementById('m-organic-pct').textContent = srcTotal > 0 ? Math.round(organicSessions/srcTotal*100) + '%' : '‚Äî';

  // Return visit frequency (sessions per returning user)
  const main = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    metrics: [{ name: 'totalUsers' }, { name: 'newUsers' }, { name: 'sessions' }]
  });
  const totalU = parseInt(gVal(main,0,0));
  const newU = parseInt(gVal(main,0,1));
  const totalS = parseInt(gVal(main,0,2));
  const retU = Math.max(1, totalU - newU);
  const retSessions = Math.max(0, totalS - newU); // approximate: each new user ~ 1 session
  const freq = retU > 0 ? (retSessions / retU).toFixed(1) : '‚Äî';
  document.getElementById('m-return-freq').textContent = freq + 'x';

  // Source verification rate (outbound_click / totalUsers)
  const outbound = await ga4Query({
    dateRanges: [{ startDate: '28daysAgo', endDate: 'today' }],
    metrics: [{ name: 'eventCount' }],
    dimensionFilter: { filter: { fieldName: 'eventName', stringFilter: { value: 'outbound_click' } } }
  });
  const outClicks = parseInt(gVal(outbound,0,0));
  document.getElementById('m-source-verify').textContent = totalU > 0 ? Math.round(outClicks/totalU*100) + '%' : '‚Äî';

  // Compare with previous period for trends
  const prevSrc = await ga4Query({
    dateRanges: [
      { startDate: '28daysAgo', endDate: 'today' },
      { startDate: '56daysAgo', endDate: '29daysAgo' }
    ],
    dimensions: [{ name: 'sessionDefaultChannelGroup' }],
    metrics: [{ name: 'sessions' }]
  });
  // Trend indicators
  let prevDirect = 0, prevTotal = 0;
  if(prevSrc.rows){
    prevSrc.rows.forEach(r => {
      const ch = r.dimensionValues[0].value;
      const curr = parseInt(r.metricValues[0].value);
      const prev = r.metricValues[1] ? parseInt(r.metricValues[1].value) : 0;
      if(ch === 'Direct'){
        prevDirect = prev;
      }
      prevTotal += prev;
    });
  }
  setTrend('m-direct-trend', directSessions, prevDirect);
  setTrend('m-organic-trend', organicSessions, prevTotal > 0 ? Math.round(organicSessions/srcTotal * prevTotal) : 0);
}

function setTrend(id, current, previous){
  const el = document.getElementById(id);
  if(!el) return;
  if(previous === 0){ el.textContent = 'New'; el.className = 'cred-trend flat'; return; }
  const change = Math.round((current - previous) / previous * 100);
  if(change > 5){
    el.textContent = '‚Üë ' + change + '% vs prev 28d';
    el.className = 'cred-trend up';
  } else if(change < -5){
    el.textContent = '‚Üì ' + Math.abs(change) + '% vs prev 28d';
    el.className = 'cred-trend down';
  } else {
    el.textContent = '‚Üí Stable vs prev 28d';
    el.className = 'cred-trend flat';
  }
}

// ‚îÄ‚îÄ SECTION 6: RISK SIGNALS ‚îÄ‚îÄ
async function fetchRiskSignals(){
  // Compare this week vs last week for spike detection
  const thisWeek = await ga4Query({
    dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
    metrics: [{ name: 'sessions' }]
  });
  const lastWeek = await ga4Query({
    dateRanges: [{ startDate: '14daysAgo', endDate: '8daysAgo' }],
    metrics: [{ name: 'sessions' }]
  });
  const tw = parseInt(gVal(thisWeek,0,0));
  const lw = parseInt(gVal(lastWeek,0,0));
  const spikeRatio = lw > 0 ? (tw / lw) : 1;
  const spikeEl = document.getElementById('risk-traffic-spike');
  const spikeVal = document.getElementById('risk-spike-val');

  if(spikeRatio > 3){
    spikeEl.className = 'risk-signal alert';
    spikeVal.textContent = '‚ö† ' + Math.round(spikeRatio*100) + '% of last week';
  } else if(spikeRatio > 1.5){
    spikeEl.className = 'risk-signal warn';
    spikeVal.textContent = '‚ö° ' + Math.round(spikeRatio*100) + '% of last week';
  } else {
    spikeEl.className = 'risk-signal';
    spikeVal.textContent = '‚úì Normal (' + fmt(tw) + ' sessions)';
  }

  // SL traffic drop detection
  const slThisWeek = await ga4Query({
    dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'country' }],
    metrics: [{ name: 'sessions' }],
    dimensionFilter: { filter: { fieldName: 'country', stringFilter: { value: 'Sri Lanka' } } }
  });
  const slLastWeek = await ga4Query({
    dateRanges: [{ startDate: '14daysAgo', endDate: '8daysAgo' }],
    dimensions: [{ name: 'country' }],
    metrics: [{ name: 'sessions' }],
    dimensionFilter: { filter: { fieldName: 'country', stringFilter: { value: 'Sri Lanka' } } }
  });
  const slTw = parseInt(gVal(slThisWeek,0,0));
  const slLw = parseInt(gVal(slLastWeek,0,0));
  const slDropEl = document.getElementById('risk-sl-drop');
  const slDropVal = document.getElementById('risk-sl-drop-val');

  if(slLw > 10 && slTw < slLw * 0.3){
    slDropEl.className = 'risk-signal alert';
    slDropVal.textContent = '‚ö† -' + Math.round((1 - slTw/slLw)*100) + '% ‚Äî check for blocking';
  } else if(slLw > 5 && slTw < slLw * 0.5){
    slDropEl.className = 'risk-signal warn';
    slDropVal.textContent = '‚ö° -' + Math.round((1 - slTw/slLw)*100) + '% from SL';
  } else {
    slDropEl.className = 'risk-signal';
    slDropVal.textContent = '‚úì Normal (' + fmt(slTw) + ' SL sessions)';
  }

  // Admin page probing ‚Äî check for hits on analytics.html, sources.html
  const probePages = await ga4Query({
    dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'pagePath' }],
    metrics: [{ name: 'screenPageViews' }],
    dimensionFilter: {
      orGroup: {
        expressions: [
          { filter: { fieldName: 'pagePath', stringFilter: { value: 'analytics.html', matchType: 'CONTAINS' } } },
          { filter: { fieldName: 'pagePath', stringFilter: { value: 'sources.html', matchType: 'CONTAINS' } } }
        ]
      }
    }
  });
  let probeHits = 0;
  (probePages.rows || []).forEach(r => { probeHits += parseInt(r.metricValues[0].value); });
  const probeEl = document.getElementById('risk-bounce');
  const probeVal = document.getElementById('risk-probe-val');
  if(probeHits > 20){
    probeEl.className = 'risk-signal alert';
    probeVal.textContent = '‚ö† ' + probeHits + ' hits this week';
  } else if(probeHits > 5){
    probeEl.className = 'risk-signal warn';
    probeVal.textContent = '‚ö° ' + probeHits + ' hits this week';
  } else {
    probeEl.className = 'risk-signal';
    probeVal.textContent = '‚úì ' + probeHits + ' hits (normal)';
  }

  // Hostile referrers ‚Äî flag unusual referral sources
  const refs = await ga4Query({
    dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
    dimensions: [{ name: 'sessionSource' }],
    metrics: [{ name: 'sessions' }],
    orderBys: [{ metric: { metricName: 'sessions' }, desc: true }],
    limit: 15
  });
  const refEl = document.getElementById('risk-referrer');
  const refVal = document.getElementById('risk-referrer-val');
  const knownSafe = ['google','direct','(direct)','(none)','facebook','twitter','whatsapp','t.co','linkedin','bing','yahoo','baidu','duckduckgo','t.me','reddit','youtube','instagram'];
  let unknownRefs = [];
  (refs.rows || []).forEach(r => {
    const src = (r.dimensionValues[0].value || '').toLowerCase();
    const c = parseInt(r.metricValues[0].value);
    if(c >= 3 && !knownSafe.some(s => src.includes(s))){
      unknownRefs.push(src + ' (' + c + ')');
    }
  });
  if(unknownRefs.length > 3){
    refEl.className = 'risk-signal warn';
    refVal.textContent = '‚ö° ' + unknownRefs.length + ' unusual sources';
  } else {
    refEl.className = 'risk-signal';
    refVal.textContent = '‚úì All referrals normal';
  }
}

// ‚îÄ‚îÄ WEEKLY BRIEFING GENERATOR ‚îÄ‚îÄ
async function generateWeeklyBriefing(){
  const now = new Date();
  const weekAgo = new Date(now - 7*24*60*60*1000);
  document.getElementById('briefing-date').textContent = weekAgo.toLocaleDateString('en-GB',{day:'2-digit',month:'short'}) + ' ‚Äî ' + now.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});

  try {
    // Q1: Growing in the right places?
    const reach = await ga4Query({
      dateRanges: [
        { startDate: '7daysAgo', endDate: 'today' },
        { startDate: '14daysAgo', endDate: '8daysAgo' }
      ],
      metrics: [{ name: 'newUsers' }]
    });
    const newThis = parseInt(gVal(reach,0,0));
    const newPrev = reach.rows && reach.rows[0] && reach.rows[0].metricValues[1] ? parseInt(reach.rows[0].metricValues[1].value) : 0;
    const newChange = newPrev > 0 ? Math.round((newThis-newPrev)/newPrev*100) : 0;
    const newDir = newChange > 0 ? 'up' : newChange < 0 ? 'down' : 'flat';
    document.getElementById('brief-1').innerHTML = '<span class="val">' + newThis + '</span> new users this week <span class="' + newDir + '">(' + (newChange >= 0 ? '+' : '') + newChange + '% vs last week)</span>. Check diaspora countries and Sinhala toggle rates below.';

    // Q2: Actually reading?
    const engage = await ga4Query({
      dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
      metrics: [{ name: 'averageSessionDuration' }, { name: 'totalUsers' }]
    });
    const avgTime = Math.round(parseFloat(gVal(engage,0,0)));
    const weekUsers = parseInt(gVal(engage,0,1));

    // Deep readers (scroll ‚â•75%)
    const deepScroll = await ga4Query({
      dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
      metrics: [{ name: 'eventCount' }],
      dimensionFilter: {
        andGroup: {
          expressions: [
            { filter: { fieldName: 'eventName', stringFilter: { value: 'scroll_depth' } } },
            { filter: { fieldName: 'customEvent:percent', numericFilter: { operation: 'GREATER_THAN_OR_EQUAL', value: { int64Value: '75' } } } }
          ]
        }
      }
    });
    const deepCount = parseInt(gVal(deepScroll,0,0));
    const deepPct = weekUsers > 0 ? Math.round(deepCount/weekUsers*100) : 0;

    let readAssess = '';
    if(avgTime > 180) readAssess = 'Strong engagement ‚Äî people are reading deeply.';
    else if(avgTime > 60) readAssess = 'Moderate engagement. Consider shorter summaries at top.';
    else readAssess = 'Low engagement ‚Äî content may be too long or academic. Try digestible summaries.';

    document.getElementById('brief-2').innerHTML = 'Avg time: <span class="val">' + secs(avgTime) + '</span> ¬∑ Deep readers (75%+ scroll): <span class="val">' + fmt(deepCount) + '</span> (' + deepPct + '% of users). ' + readAssess;

    // Q3: Resonating?
    const topPage = await ga4Query({
      dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
      dimensions: [{ name: 'pageTitle' }],
      metrics: [{ name: 'averageSessionDuration' }],
      orderBys: [{ metric: { metricName: 'averageSessionDuration' }, desc: true }],
      limit: 3
    });
    let topTitles = [];
    (topPage.rows || []).slice(0,3).forEach(r => {
      topTitles.push('"' + r.dimensionValues[0].value.slice(0,40) + '" (' + secs(r.metricValues[0].value) + ' avg)');
    });
    document.getElementById('brief-3').innerHTML = 'Top by engagement: ' + (topTitles.join(', ') || 'Not enough data') + '. This tells you what <em>style</em> and topics connect.';

    // Q4: Building trust?
    const retRate = weekUsers > 0 ? Math.round((weekUsers - newThis)/weekUsers*100) : 0;
    let trustAssess = '';
    if(retRate > 40) trustAssess = 'Healthy community forming ‚Äî people come back.';
    else if(retRate > 20) trustAssess = 'Growing recognition. Keep publishing consistently.';
    else trustAssess = 'Mostly new visitors. Focus on getting first return visit.';
    document.getElementById('brief-4').innerHTML = 'Return rate: <span class="val">' + retRate + '%</span>. ' + trustAssess;

    // Q5: What next?
    let nextItems = [];
    if(deepPct < 30) nextItems.push('Low completion rate ‚Äî add executive summaries');
    if(retRate < 25) nextItems.push('Low returns ‚Äî add email signup or push notifications');
    if(newThis < 10) nextItems.push('Low reach ‚Äî share on social, optimise SEO');
    if(avgTime < 60) nextItems.push('Very short sessions ‚Äî make content more scannable');
    if(nextItems.length === 0) nextItems.push('Metrics look healthy. Keep the current cadence.');
    document.getElementById('brief-5').innerHTML = nextItems.map(n => '‚Üí ' + n).join('<br>');

  } catch(e) {
    document.getElementById('brief-1').innerHTML = 'Error generating briefing: ' + e.message;
  }
}

// ‚îÄ‚îÄ SITEMAP / ROBOTS ‚îÄ‚îÄ
const DOSSIER_URLS = [
  'https://analyst.rizrazak.com/',
  'https://analyst.rizrazak.com/dossiers/sri-lanka-cricket-corruption/',
  'https://analyst.rizrazak.com/dossiers/sri-lanka-cricket-corruption/betting-web.html',
  'https://analyst.rizrazak.com/dossiers/sri-lanka-cricket-corruption/kalathma-scandal.html',
  'https://analyst.rizrazak.com/dossiers/sri-lanka-cricket-corruption/mindmap.html',
  'https://analyst.rizrazak.com/dossiers/sri-lanka-cricket-corruption/power-network.html',
  'https://analyst.rizrazak.com/dossiers/easter-sunday-attacks-suresh-sallay/',
  'https://analyst.rizrazak.com/dossiers/easter-sunday-attacks-suresh-sallay/conspiracy-board.html',
];

function generateSitemap(){
  const today = new Date().toISOString().slice(0,10);
  const xml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
${DOSSIER_URLS.map(u=>`  <url>
    <loc>${u}</loc>
    <lastmod>${today}</lastmod>
    <changefreq>weekly</changefreq>
    <priority>${u === 'https://analyst.rizrazak.com/' ? '1.0' : '0.8'}</priority>
  </url>`).join('\n')}
</urlset>`;
  const blob = new Blob([xml], {type:'application/xml'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sitemap.xml';
  a.click();
  URL.revokeObjectURL(a.href);
  alert('‚úì sitemap.xml downloaded.\n\n1. Place it at the root of your GitHub Pages site (alongside index.html)\n2. Submit the URL https://analyst.rizrazak.com/sitemap.xml in Google Search Console.');
}

function generateRobotsTxt(){
  const txt = `User-agent: *
Allow: /

# Block admin and private pages
Disallow: /dossiers/sri-lanka-cricket-corruption/analytics.html
Disallow: /dossiers/sri-lanka-cricket-corruption/sources.html

# Sitemap
Sitemap: https://analyst.rizrazak.com/sitemap.xml
`;
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'robots.txt';
  a.click();
  URL.revokeObjectURL(a.href);
  alert('‚úì robots.txt downloaded.\n\nPlace it at the root of your GitHub Pages site.');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
loadDashboard();
loadAnalyticsIds();
</script>
</body>
</html>
